<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Assentamento Rural</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #3d2b1f; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        canvas { 
            display: block; 
            touch-action: none; 
        }
        
        /* Logo do Jogo */
        #logoJogo {
            position: fixed;
            top: 10px;
            left: 20px;
            z-index: 101;
            width: 125px;
            height: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #logoJogo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.7));
        }
        
        /* Menu do Barraco */
        #menuBarraca {
            position: fixed;
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #8B4513;
            border-radius: 15px;
            padding: 20px;
            width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Menu da Planta */
        #menuPlanta {
            position: fixed;
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #228B22;
            border-radius: 15px;
            padding: 20px;
            width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
/* Modal Carrossel Cr√©dito */
#modalCarrosselCredito {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    border: 3px solid #2E8B57;
    border-radius: 15px;
    padding: 25px;
    width: 500px;
    max-width: 90%;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    z-index: 2000;
    display: none;
}

.conteudo-credito-item {
    text-align: center;
    padding: 20px 0;
}

.conteudo-credito-titulo {
    font-size: 20px;
    font-weight: bold;
    color: #2E8B57;
    margin-bottom: 15px;
}

.conteudo-credito-descricao {
    font-size: 16px;
    color: #555;
    line-height: 1.5;
}

.indicador-carrossel {
    text-align: center;
    margin-top: 15px;
    color: #666;
    font-size: 14px;
}
       
        /* Modal Invent√°rio - ATUALIZADO */
        #modalInventario {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #8B4513;
            border-radius: 15px;
            padding: 25px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
            overflow-y: auto;
        }
        
        /* Modal Reformar - ATUALIZADO */
        #modalReformar {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #D2691E;
            border-radius: 15px;
            padding: 25px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
        }
        
        /* Modal Sair do Assentamento */
        #modalSairAssentamento {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #DC143C;
            border-radius: 15px;
            padding: 25px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
        }
        
        /* Modal Conversa (para di√°logos) */
        #modalConversa {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #2E8B57;
            border-radius: 15px;
            padding: 25px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
        }
        
        /* Modal Comer */
        #modalComer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #FF6B6B;
            border-radius: 15px;
            padding: 25px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
        }
        
        /* Tela de Dormir */
        #telaDormir {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        /* Tela Game Over */
        #telaGameOver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        
        /* Tela Fim de Jogo Especial */
        #telaFimEspecial {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            z-index: 4000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .fim-especial-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 5px solid #2E8B57;
        }
        
        .fim-especial-logo {
            width: 200px;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        
        .fim-especial-titulo {
            font-size: 48px;
            color: #2E8B57;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .fim-especial-mensagem {
            font-size: 24px;
            color: #5C3317;
            margin-bottom: 30px;
            line-height: 1.4;
        }
        
        .fim-especial-descricao {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        #menuBarraca h3, #menuPlanta h3, .modal-titulo {
            margin: 0 0 15px 0;
            text-align: center;
            border-bottom: 2px solid;
            padding-bottom: 8px;
            font-size: 18px;
        }
        
        #menuBarraca h3 {
            color: #8B4513;
            border-bottom-color: #D2B48C;
        }
        
        #menuPlanta h3 {
            color: #228B22;
            border-bottom-color: #90EE90;
        }
        
        .modal-titulo {
            color: #2E8B57;
            border-bottom-color: #90EE90;
            font-size: 20px;
        }
        
        .opcao-menu {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin: 8px 0;
            background: #D2B48C;
            border: 2px solid #8B4513;
            border-radius: 8px;
            color: #5C3317;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .opcao-planta {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            box-sizing: border-box;
            border: 2px solid;
        }
        
        .btn-desenvolver {
            background: #90EE90;
            border-color: #228B22;
            color: #006400;
        }
        
        .btn-desenvolver:hover {
            background: #228B22;
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-receber {
            background: #FFD700;
            border-color: #FF8C00;
            color: #8B4513;
        }
        
        .btn-receber:hover {
            background: #FF8C00;
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-remover {
            background: #FFB6C1;
            border-color: #DC143C;
            color: #8B0000;
        }
        
        .btn-remover:hover {
            background: #DC143C;
            color: white;
            transform: translateY(-2px);
        }
        
        .opcao-menu:hover {
            background: #8B4513;
            color: white;
            transform: translateY(-2px);
        }
        
        .opcao-menu:active, .opcao-planta:active {
            transform: translateY(0);
        }
        
        #fecharMenu, #fecharMenuPlanta, .fechar-modal {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #8B4513;
            font-weight: bold;
            line-height: 1;
            padding: 0;
            width: 25px;
            height: 25px;
        }
        
        #fecharMenuPlanta {
            color: #228B22;
        }
        
        /* Indicadores do Jogo (canto superior direito) */
        #indicadoresJogo {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }
        
        .indicador {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            min-width: 90px;
            text-align: center;
            transition: all 0.3s;
        }
        
        #nivelIndicador {
            border-color: #FFD700;
            background: linear-gradient(135deg, #8B4513, #D2691E);
        }
        
        #nivelIndicador .nivel-numero {
            color: #FFD700;
            font-size: 16px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        
        #dinheiroIndicador {
            border-color: #32CD32;
            background: linear-gradient(135deg, #006400, #228B22);
        }
        
        #dinheiroIndicador .dinheiro-numero {
            color: #90EE90;
            font-size: 14px;
            text-shadow: 0 0 6px rgba(144, 238, 144, 0.7);
        }
        
        #dinheiroIndicador .emoji-dinheiro {
            font-size: 14px;
            margin-right: 3px;
        }
        
  
        /* Sistema de Indicadores */
        #sistemaIndicadores {
            position: fixed;
            top: 140px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-start;
        }
        
        .indicador-simples {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            min-width: 60px;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .indicador-alimentacao {
            border-left: 3px solid #FF6B6B;
        }
        
        .indicador-agua {
            border-left: 3px solid #4ECDC4;
        }
        
        .indicador-vinculo {
            border-left: 3px solid #FFD93D;
        }
        
        .indicador-descanso {
            border-left: 3px solid #9B59B6;
        }
        
        .indicador-valor {
            font-size: 14px;
            font-weight: bold;
        }
        
        .indicador-baixo {
            animation: pulsar 1s infinite;
        }
        
        .indicador-critico {
            animation: pulsarCritico 0.5s infinite;
        }
        
        @keyframes pulsar {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @keyframes pulsarCritico {
            0% { 
                opacity: 1; 
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }
            70% { 
                opacity: 0.8; 
                box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
            }
            100% { 
                opacity: 1; 
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
            }
        }
        
        /* Barra de progresso da planta */
        .progresso-planta {
            margin: 15px 0;
            text-align: center;
        }
        
        .progresso-texto {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #228B22;
        }
        
        .progresso-barra-container {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        
        .progresso-barra {
            height: 100%;
            background: linear-gradient(90deg, #90EE90, #228B22);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        /* Barra de progresso dormir */
        #barraDormir {
            width: 80%;
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            border: 2px solid #9B59B6;
        }
        
        #progressoDormir {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #9B59B6);
            width: 0%;
            transition: width 0.1s linear;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* Grid do Invent√°rio - ATUALIZADO: 4x3 */
        #gridInventario {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Alterado para 4 colunas */
            gap: 10px;
            margin: 20px 0;
        }
        
        .slot-inventario {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #D2B48C, #8B4513);
            border: 2px solid #A0522D;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .slot-inventario:hover {
            transform: scale(1.05);
            background: linear-gradient(135deg, #E6C9A8, #A0522D);
        }
        
        .slot-inventario.vazio {
            background: linear-gradient(135deg, #F5DEB3, #DEB887);
            border: 2px dashed #A0522D;
        }
        
        .slot-quantidade {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 1px 4px;
            border-radius: 4px;
            min-width: 20px;
            text-align: center;
        }
        
        /* Slot de item selecionado no invent√°rio */
        #slotSelecionadoContainer {
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #FFF8DC, #F5DEB3);
            border-radius: 10px;
            border: 3px solid #8B4513;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #slotSelecionado {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        #slotSelecionadoEmoji {
            font-size: 60px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 15px;
            border: 3px solid #8B4513;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        #slotSelecionadoInfo {
            flex: 1;
        }
        
        #slotSelecionadoNome {
            font-weight: bold;
            font-size: 22px;
            color: #5C3317;
            margin-bottom: 5px;
        }
        
        #slotSelecionadoTipo {
            font-size: 16px;
            color: #8B4513;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        #slotSelecionadoQuantidade {
            font-size: 16px;
            color: #666;
            font-weight: bold;
        }
        
        .acoes-inventario {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .btn-acao {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-consumir {
            background: linear-gradient(135deg, #FF6B6B, #FF4040);
            color: white;
            border: 2px solid #DC143C;
        }
        
        .btn-consumir:hover:not(:disabled) {
            background: linear-gradient(135deg, #FF4040, #DC143C);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }
        
        .btn-usar {
            background: linear-gradient(135deg, #4ECDC4, #2E8B57);
            color: white;
            border: 2px solid #228B22;
        }
        
        .btn-usar:hover:not(:disabled) {
            background: linear-gradient(135deg, #2E8B57, #006400);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 128, 0, 0.3);
        }
        
        .btn-vender {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #8B4513;
            border: 2px solid #FF8C00;
        }
        
        .btn-vender:hover:not(:disabled) {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.3);
        }
        
        .btn-acao:disabled {
            background: #cccccc;
            color: #666666;
            border: 2px solid #999999;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Item em uso (canto inferior direito) */
        #itemEmUso {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #FFD700;
            border-radius: 15px;
            padding: 15px;
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
            width: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 1;
            pointer-events: auto;
        }
        
        #itemEmUso:hover {
            transform: scale(1.05);
            background: rgba(139, 69, 19, 0.9);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.6);
        }
        
        #itemEmUso:active {
            transform: scale(0.95);
        }
        
        #itemEmUsoEmoji {
            font-size: 40px;
        }
        
        #itemEmUsoNome {
            color: #FFD700;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        /* Alertas - Centralizados */
        .alerta {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid;
            border-radius: 15px;
            padding: 25px 30px;
            z-index: 2000;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            display: none;
            animation: aparecer 0.3s ease-out;
            max-width: 400px;
            width: 90%;
        }
        
        @keyframes aparecer {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        
        .alerta-sucesso {
            border-color: #32CD32;
            background: linear-gradient(135deg, #fff, #F0FFF0);
        }
        
        .alerta-aviso {
            border-color: #FFA500;
            background: linear-gradient(135deg, #fff, #FFF8DC);
        }
        
        .alerta-perigo {
            border-color: #DC143C;
            background: linear-gradient(135deg, #fff, #FFE4E1);
        }
        
        .alerta-emoji {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .alerta-titulo {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .alerta-mensagem {
            font-size: 16px;
            color: #555;
            line-height: 1.4;
        }
        
        .fechar-alerta {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
            font-weight: bold;
            line-height: 1;
            padding: 0;
            width: 25px;
            height: 25px;
        }
        
        /* Navega√ß√£o do modal de conversa */
        .navegacao-conversa {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .btn-navegacao {
            background: #8B4513;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn-navegacao:hover {
            background: #A0522D;
            transform: translateY(-2px);
        }
        
        .btn-navegacao:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Estilos para o modal de cr√©dito */
        .lista-credito {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .opcao-credito {
            padding: 10px;
            margin: 5px 0;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .opcao-credito:hover {
            background: #e8f5e8;
            border-color: #228B22;
        }
        
        .opcao-credito.selecionada {
            background: #d4edda;
            border-color: #228B22;
            font-weight: bold;
        }
        
        /* Estilos para reforma */
        .info-reforma {
            background: #f0f8ff;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .nivel-barraca {
            font-size: 24px;
            font-weight: bold;
            color: #D2691E;
            text-align: center;
            margin: 10px 0;
        }
        
        .custo-reforma {
            background: #fffacd;
            border: 2px solid #FFD700;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }
        
        /* Bot√µes */
        .btn-primario {
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primario:hover {
            background: linear-gradient(135deg, #228B22, #006400);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secundario {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secundario:hover {
            background: linear-gradient(135deg, #2980b9, #1c6ea4);
        }
        
        .btn-gameover {
            background: linear-gradient(135deg, #FF416C, #FF4B2B);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s;
        }
        
        .btn-gameover:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 65, 108, 0.5);
        }
        
        /* √Åudio controls escondidos */
        audio {
            display: none;
        }
        
        /* Emoji grande na tela de dormir */
        .emoji-grande {
            font-size: 100px;
            margin: 20px 0;
            animation: respirar 2s infinite;
        }
        
        @keyframes respirar {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Game Over styles */
        .gameover-titulo {
            font-size: 48px;
            color: #FF416C;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 65, 108, 0.5);
        }
        
        .gameover-motivo {
            font-size: 24px;
            color: #FFD700;
            margin-bottom: 30px;
        }
        
        /* Container para efeitos sonoros */
        #audioContainer {
            display: none;
        }
        
        /* Estilo para texto da barraca do personagem */
        .sua-casa {
            background: rgba(139, 69, 19, 0.8);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* Modal Comer - Estilos */
        .lista-alimentos {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            border: 2px solid #FF6B6B;
            border-radius: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #FFF5F5, #FFE4E1);
        }
        
        .item-alimento {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            margin: 8px 0;
            background: white;
            border: 2px solid #FFB6C1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .item-alimento:hover {
            background: #FFF5F5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.2);
        }
        
        .alimento-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .alimento-emoji {
            font-size: 30px;
        }
        
        .alimento-detalhes {
            flex: 1;
        }
        
        .alimento-nome {
            font-weight: bold;
            color: #5C3317;
            font-size: 16px;
        }
        
        .alimento-quantidade {
            color: #666;
            font-size: 14px;
        }
        
        .btn-comer {
            background: linear-gradient(135deg, #FF6B6B, #FF4040);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-comer:hover {
            background: linear-gradient(135deg, #FF4040, #DC143C);
            transform: translateY(-2px);
        }
        
        /* Controle de Navega√ß√£o */
        #miniMapaBtn {
            position: fixed;
            bottom: 60px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 50%;
            font-size: 24px;
            z-index: 100;
            border: 2px solid #8B4513;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        #miniMapaBtn:hover {
            background: rgba(139, 69, 19, 0.9);
            transform: scale(1.1);
        }

        /* Display de Coordenadas */
        #coordenadasDisplay {
            position: fixed;
            bottom: 60px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #00FF00;
            padding: 10px 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 16px;
            z-index: 100;
            border: 2px solid #00FF00;
            display: none;
            font-weight: bold;
        }

        .coordenada {
            color: #00FFFF;
        }
        
        /* Anima√ß√£o para efeito de comer */
        @keyframes subirDesaparecer {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -100px) scale(0.5);
            }
        }
        
        /* Rodap√© de Cr√©dito */
        #rodapeCredito {
            position: fixed;
            bottom: 5px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 10px;
            background-color: rgba(139, 69, 19, 0.9);
            border: 1px solid #32CD32;
            padding: 3px 0;
            z-index: 500;
            font-family: Arial, sans-serif;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }
        
        /* Seletores de Personagem - ATUALIZADO: Agora abaixo do dinheiro */
        #seletoresPersonagem {
            position: fixed;
            top: 120px; /* Abaixo do dinheiro (que est√° em 60px) */
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #8B4513;
        }
        
        .emoji-personagem {
            font-size: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .emoji-personagem:hover {
            transform: scale(1.1);
        }
        
        .emoji-personagem.selecionado {
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            background: #FFD700;
        }
        
        .emoji-personagem[data-personagem="pai"] {
            border-color: #4A90E2;
        }
        
        .emoji-personagem[data-personagem="mae"] {
            border-color: #E24A9E;
        }
        
        .emoji-personagem[data-personagem="filho"] {
            border-color: #4AE2A5;
        }
        
        /* Anima√ß√µes de ferramentas */
        @keyframes pescarAnimacao {
            0% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
            25% { transform: translate(-50%, -60%) rotate(-30deg); }
            50% { transform: translate(-50%, -70%) rotate(30deg); }
            75% { transform: translate(-50%, -60%) rotate(-15deg); }
            100% { transform: translate(-50%, -100px) rotate(0deg); opacity: 0; }
        }

        @keyframes machadoAnimacao {
            0% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
            25% { transform: translate(-40%, -60%) rotate(90deg); }
            50% { transform: translate(-50%, -70%) rotate(180deg); }
            75% { transform: translate(-60%, -60%) rotate(270deg); }
            100% { transform: translate(-50%, -100px) rotate(360deg); opacity: 0; }
        }

        @keyframes facaAnimacao {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            25% { transform: translate(-40%, -60%) scale(1.2) rotate(-15deg); }
            50% { transform: translate(-60%, -60%) scale(1.2) rotate(15deg); }
            75% { transform: translate(-50%, -70%) scale(1.1) rotate(-5deg); }
            100% { transform: translate(-50%, -100px) scale(1) rotate(0deg); opacity: 0; }
        }

        @keyframes enxadaAnimacao {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            25% { transform: translate(-45%, -55%) scale(1.1) rotate(-10deg); }
            50% { transform: translate(-55%, -55%) scale(1.1) rotate(10deg); }
            75% { transform: translate(-50%, -60%) scale(1.05) rotate(-5deg); }
            100% { transform: translate(-50%, -100px) scale(1) rotate(0deg); opacity: 0; }
        }

        @keyframes marteloAnimacao {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            25% { transform: translate(-50%, -55%) scale(1.1) rotate(-5deg); }
            50% { transform: translate(-50%, -60%) scale(1.2) rotate(5deg); }
            75% { transform: translate(-50%, -55%) scale(1.1) rotate(-2deg); }
            100% { transform: translate(-50%, -100px) scale(1) rotate(0deg); opacity: 0; }
        }

        @keyframes recipienteAnimacao {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            25% { transform: translate(-50%, -55%) scale(1.05); }
            50% { transform: translate(-50%, -60%) scale(1.1); }
            75% { transform: translate(-50%, -55%) scale(1.05); }
            100% { transform: translate(-50%, -100px) scale(1); opacity: 0; }
        }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<!-- Logo do Jogo -->
<img id="logoJogo" src="https://imgur.com/MtVHTvK.png" alt="Assentamento Rural">

<!-- Menu do Barraco -->
<div id="menuBarraca">
    <button id="fecharMenu">√ó</button>
    <h3 id="tituloMenu">Barraco</h3>
    <div class="opcoes-container"></div>
</div>

<!-- Menu da Planta -->
<div id="menuPlanta">
    <button id="fecharMenuPlanta">√ó</button>
    <h3 id="tituloPlanta">Planta üå±</h3>
    <div class="progresso-planta">
        <div class="progresso-texto">Progresso: <span id="porcentagemPlanta">0</span>%</div>
        <div class="progresso-barra-container">
            <div class="progresso-barra" id="barraProgressoPlanta" style="width: 0%;">0%</div>
        </div>
    </div>
    <button class="opcao-planta btn-desenvolver" id="btnDesenvolver" onclick="desenvolverPlanta()">üå± Desenvolver</button>
    <button class="opcao-planta" id="btnAcao" onclick="acaoPlanta()">üóëÔ∏è Remover Planta</button>
</div>

<!-- Modal Carrossel Cr√©dito -->
<div id="modalCarrosselCredito">
    <button class="fechar-modal" onclick="fecharModal('modalCarrosselCredito')">√ó</button>
    <h3 class="modal-titulo">Modalidades de Cr√©dito - INCRA</h3>
    <div id="conteudoCarrosselCredito" style="margin-bottom: 20px; line-height: 1.6; min-height: 150px;">
        <!-- Conte√∫do do carrossel ser√° inserido aqui -->
    </div>
    <div class="navegacao-conversa" style="justify-content: center;">
        <button class="btn-navegacao" id="btnAnteriorCredito" onclick="navegarCarrosselCredito(-1)">‚Üê Anterior</button>
        <button class="btn-navegacao" id="btnProximoCredito" onclick="navegarCarrosselCredito(1)">Pr√≥ximo</button>
        <button class="btn-navegacao" id="btnReceberCredito" onclick="receberCreditoApoio()" style="background: linear-gradient(135deg, #32CD32, #228B22); display: none;">
            üí≥ RECEBER CR√âDITO
        </button>
    </div>
</div>

<!-- Modal Invent√°rio ATUALIZADO 4x3 -->
<div id="modalInventario">
    <button class="fechar-modal" onclick="fecharModal('modalInventario')">√ó</button>
    <h3 class="modal-titulo">Invent√°rio üéí</h3>
    <div id="gridInventario">
        <!-- 12 slots ser√£o gerados dinamicamente -->
    </div>
    
    <!-- Slot de item selecionado -->
    <div id="slotSelecionadoContainer">
        <div id="slotSelecionado">
            <div id="slotSelecionadoEmoji">‚ùì</div>
            <div id="slotSelecionadoInfo">
                <div id="slotSelecionadoNome">Nenhum item selecionado</div>
                <div id="slotSelecionadoTipo">Clique em um item para selecionar</div>
                <div id="slotSelecionadoQuantidade">Quantidade: 0</div>
            </div>
        </div>
        <div class="acoes-inventario">
            <button class="btn-acao btn-consumir" onclick="consumirItem()" disabled id="btnConsumir">
                <span>üçΩÔ∏è</span> Comer
            </button>
            <button class="btn-acao btn-usar" onclick="usarItem()" disabled id="btnUsar">
                <span>‚úã</span> Usar
            </button>
            <button class="btn-acao btn-vender" onclick="venderItem()" disabled id="btnVender">
                <span>üí∞</span> Vender
            </button>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 20px; color: #666;">
        <small>12 slots dispon√≠veis (4x3) - Clique em um item para selecion√°-lo</small>
    </div>
</div>

<!-- Modal Reformar - ATUALIZADO -->
<div id="modalReformar">
    <button class="fechar-modal" onclick="fecharModal('modalReformar')">√ó</button>
    <h3 class="modal-titulo">Reformar Casa üî®</h3>
    
    <div class="nivel-barraca">
        <div style="font-size: 24px; color: #D2691E; font-weight: bold; margin-bottom: 10px;">
            N√≠vel da Casa: <span id="nivelBarracaAtual">1</span>
        </div>
        <div style="font-size: 18px; color: #228B22; margin-bottom: 15px;">
            Pr√≥ximo N√≠vel: <span id="proximoNivelBarraca">2</span>
        </div>
    </div>
    
    <div class="progresso-reforma" style="margin: 20px 0;">
        <div class="progresso-texto" style="font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #8B4513;">
            Progresso da Reforma: <span id="porcentagemReforma">0</span>%
        </div>
        <div class="progresso-barra-container">
            <div class="progresso-barra" id="barraProgressoReforma" style="width: 0%; background: linear-gradient(90deg, #D2691E, #8B4513);">
                0%
            </div>
        </div>
        <div style="text-align: center; margin-top: 5px; font-size: 12px; color: #666;">
            Cada clique adiciona 5%.
        </div>
    </div>
    
    <div class="info-reforma">
        <p style="text-align: center; margin-bottom: 10px;"><B>REFORMAR:</B> Tenha <B>üí∞ DINHEIRO</B> e Use <B>üî® MARTELO</B>!</p>
        <p style="text-align: center; font-size: 14px; color: #666;">
            Cada n√≠vel aumenta seu conforto e status no assentamento.
        </p>
    </div>
    
    <div class="custo-reforma" style="background: #fffacd; border: 2px solid #FFD700; border-radius: 10px; padding: 15px; margin: 20px 0;">
        <h4 style="text-align: center; margin: 0 0 10px 0; color: #8B4513;">Custo da Reforma</h4>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Custo por clique:</span>
            <span style="font-weight: bold;">üí∞ R$ <span id="custoPorClique">0</span></span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Progresso atual:</span>
            <span><span id="cliquesDados">0</span>/20 cliques</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Custo total da obra:</span>
            <span style="font-weight: bold; color: #228B22;">üí∞ R$ <span id="custoTotalReforma">0</span></span>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <span>Seu dinheiro:</span>
            <span style="font-weight: bold; color: #32CD32;">üí∞ R$ <span id="dinheiroAtualReforma">0</span></span>
        </div>
    </div>
    
    <button class="btn-primario" id="btnReformar" onclick="iniciarReforma()" style="background: linear-gradient(135deg, #D2691E, #8B4513);">
        üî® Reformar (+5%)
    </button>
    
    <div style="text-align: center; margin-top: 15px; color: #666; font-size: 12px;">
        <small>PRECISA DE <B>DINHEIRO</B> PARA REFORMAR? 
 VEJA COM AS LIDERAN√áAS COMO <B>SOLICITAR O CR√âDITO INSTALA√á√ÉO DO INCRA.</B></small>
    </div>
</div>

<!-- Modal Sair do Assentamento -->
<div id="modalSairAssentamento">
    <button class="fechar-modal" onclick="fecharModal('modalSairAssentamento')">√ó</button>
    <h3 class="modal-titulo">‚ùå Sair do Assentamento</h3>
    <div id="conteudoSairAssentamento">
        <!-- Conte√∫do din√¢mico ser√° inserido aqui -->
    </div>
</div>

<!-- Modal Conversa -->
<div id="modalConversa">
    <button class="fechar-modal" onclick="fecharModal('modalConversa')">√ó</button>
    <h3 class="modal-titulo" id="tituloConversa">Conversa</h3>
    <div id="conteudoConversa" style="margin-bottom: 20px; line-height: 1.6;">
        <!-- Conte√∫do da conversa ser√° inserido aqui -->
    </div>
    <div class="navegacao-conversa">
        <button class="btn-navegacao" id="btnAnterior" onclick="navegarConversa(-1)">‚Üê Anterior</button>
        <button class="btn-navegacao" id="btnProximo" onclick="navegarConversa(1)">Pr√≥ximo ‚Üí</button>
    </div>
</div>

<!-- Modal Comer -->
<div id="modalComer">
    <button class="fechar-modal" onclick="fecharModal('modalComer')">√ó</button>
    <h3 class="modal-titulo">Comer üçΩÔ∏è</h3>
    <p style="text-align: center; margin-bottom: 15px;">Selecione um alimento para consumir e aumentar sua alimenta√ß√£o.</p>
    <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px;">Cada alimento aumenta a alimenta√ß√£o em 15% a 25%.</p>
    <div id="listaAlimentos" class="lista-alimentos">
        <!-- Itens de alimento ser√£o gerados dinamicamente -->
    </div>
    <div style="text-align: center; margin-top: 15px; color: #888; font-size: 12px;">
        Voc√™ tamb√©m pode consumir alimentos diretamente no invent√°rio
    </div>
</div>

<!-- Tela de Dormir -->
<!-- Tela de Dormir -->
<div id="telaDormir">
    <div class="emoji-grande">üí§</div>
    <h2 style="font-size: 36px; margin: 20px 0;">Dormindo...</h2>
    <div id="barraDormir">
        <div id="progressoDormir">0%</div>
    </div>
    <p style="font-size: 18px; margin-top: 20px;">Voc√™ acordar√° descansado e com mais energia para o trabalho.</p>
    
    <!-- BOT√ÉO ACORDAR -->
    <button id="btnAcordar" 
            style="display: none; margin-top: 30px; padding: 15px 30px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;"
            onclick="acordar()">
        üåÖ Acordar
    </button>
</div>

<!-- Tela Game Over -->
<div id="telaGameOver">
    <h1 class="gameover-titulo">FIM DE JOGO!</h1>
    <div class="gameover-motivo" id="motivoGameOver"></div>
    <p style="font-size: 20px; margin: 20px 0;">Sua jornada no assentamento chegou ao fim.</p>
    <p style="color: #aaa; margin-bottom: 30px;">Todos os progressos foram resetados.</p>
    <button class="btn-gameover" onclick="reiniciarJogo()">üîÑ Reiniciar Jogo</button>
</div>

<!-- Tela Fim de Jogo Especial -->
<div id="telaFimEspecial">
    <div class="fim-especial-content">
        <img src="https://imgur.com/5u5XG91.png" alt="Assentamento Rural" class="fim-especial-logo">
        <h1 class="fim-especial-titulo">FIM DE JOGO</h1>
        <div class="fim-especial-mensagem" id="mensagemFimEspecial"></div>
        <p class="fim-especial-descricao">Sua jornada no assentamento chegou ao fim, mas voc√™ saiu com dignidade e respeito.</p>
        <button class="btn-primario" onclick="reiniciarJogo()" style="background: linear-gradient(135deg, #2E8B57, #32CD32); padding: 15px 30px; font-size: 18px;">
            üîÑ Reiniciar Jogo
        </button>
    </div>
</div>

<!-- Item em uso (canto inferior direito) -->
<div id="itemEmUso" onclick="abrirInventario()" title="Clique para abrir o invent√°rio">
    <div id="itemEmUsoEmoji"></div>
    <div id="itemEmUsoNome"></div>
</div>

<!-- Alerta de Sucesso -->
<div id="alertaSucesso" class="alerta alerta-sucesso">
    <button class="fechar-alerta" onclick="fecharAlerta('alertaSucesso')">√ó</button>
    <div class="alerta-emoji">üéâ</div>
    <div class="alerta-titulo">PARAB√âNS!!</div>
    <div class="alerta-mensagem" id="mensagemSucesso">Voc√™ acaba de ganhar +10 reais pela venda.</div>
</div>

<!-- Alerta de Aviso -->
<div id="alertaAviso" class="alerta alerta-aviso">
    <button class="fechar-alerta" onclick="fecharAlerta('alertaAviso')">√ó</button>
    <div class="alerta-emoji" id="emojiAviso">‚ö†Ô∏è</div>
    <div class="alerta-titulo" id="tituloAviso">Aten√ß√£o!</div>
    <div class="alerta-mensagem" id="mensagemAviso"></div>
</div>

<!-- Alerta de Perigo -->
<div id="alertaPerigo" class="alerta alerta-perigo">
    <button class="fechar-alerta" onclick="fecharAlerta('alertaPerigo')">√ó</button>
    <div class="alerta-emoji" id="emojiPerigo">üö´</div>
    <div class="alerta-titulo" id="tituloPerigo">CRIME AMBIENTAL!</div>
    <div class="alerta-mensagem" id="mensagemPerigo"></div>
</div>

<!-- Indicadores do Jogo -->
<div id="indicadoresJogo">
    <div id="nivelIndicador" class="indicador">
        ‚≠ê Lv. <span class="nivel-numero" id="nivelNumero">1</span>
    </div>
    <div id="dinheiroIndicador" class="indicador">
        <span class="emoji-dinheiro">üíµ</span> R$ <span class="dinheiro-numero" id="dinheiroNumero">0</span>
    </div>
    <div id="casaIndicador" class="indicador">
        üè† Nv. <span class="casa-numero" id="casaNumero">1</span>
    </div>
</div>

<!-- Sistema de Indicadores -->
<div id="sistemaIndicadores">
    <div class="indicador-simples indicador-alimentacao" id="indicadorAlimentacao">
        <span>üçΩÔ∏è</span>
        <span class="indicador-valor" id="valorAlimentacao">50%</span>
    </div>
    <div class="indicador-simples indicador-agua" id="indicadorAgua">
        <span>üíß</span>
        <span class="indicador-valor" id="valorAgua">50%</span>
    </div>
    <div class="indicador-simples indicador-vinculo" id="indicadorVinculo">
        <span>ü§ù</span>
        <span class="indicador-valor" id="valorVinculo">0%</span>
    </div>
    <div class="indicador-simples indicador-descanso" id="indicadorDescanso">
        <span>üí§</span>
        <span class="indicador-valor" id="valorDescanso">100%</span>
    </div>
</div>

<!-- Seletores de Personagem - ATUALIZADO: Agora abaixo do dinheiro -->
<div id="seletoresPersonagem" class="seletor-personagem">
    <div class="emoji-personagem selecionado" data-personagem="pai" title="Pai">üöπ</div>
    <div class="emoji-personagem" data-personagem="mae" title="M√£e">üö∫</div>
    <div class="emoji-personagem" data-personagem="filho" title="Filho">üöº</div>
</div>

<!-- Controle de Navega√ß√£o -->
<div id="miniMapaBtn" title="Clique para ver coordenadas">üó∫Ô∏è</div>
<div id="coordenadasDisplay">
    X: <span id="coordX" class="coordenada">0</span> px<br>
    Y: <span id="coordY" class="coordenada">0</span> px
</div>

<!-- Container para efeitos sonoros -->
<div id="audioContainer">
    <audio id="somClique" preload="auto">
        <source src="https://assets.mixkit.co/sfx/download/mixkit-select-click-1109.mp3" type="audio/mpeg">
    </audio>
    <audio id="somSucesso" preload="auto">
        <source src="https://assets.mixkit.co/sfx/download/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    <audio id="somDinheiro" preload="auto">
        <source src="https://assets.mixkit.co/sfx/download/mixkit-cash-register-purchase-875.mp3" type="audio/mpeg">
    </audio>
    <audio id="somPlanta" preload="auto">
        <source src="https://assets.mixkit.co/sfx/download/mixkit-plant-growing-833.mp3" type="audio/mpeg">
    </audio>
    <audio id="somGameOver" preload="auto">
        <source src="https://assets.mixkit.co/sfx/download/mixkit-sad-game-over-trombone-471.mp3" type="audio/mpeg">
    </audio>
    <audio id="somAlerta" preload="auto">
        <source src="https://assets.mixkit.co/sfx/download/mixkit-warning-alarm-buzzer-1658.mp3" type="audio/mpeg">
    </audio>
    <audio id="somDormir" preload="auto">
        <source src="https://assets.mixkit.co/sfx/download/mixkit-sleeping-snore-1130.mp3" type="audio/mpeg">
    </audio>
</div>

<!-- Rodap√© de Cr√©dito -->
<footer id="rodapeCredito">
    Criado por Raphael Coutinho Santos - Analista Administrativo | INCRA ES - Matr√≠cula: 3490061
</footer>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const menuBarraca = document.getElementById('menuBarraca');
    const menuPlanta = document.getElementById('menuPlanta');
    const fecharMenu = document.getElementById('fecharMenu');
    const fecharMenuPlanta = document.getElementById('fecharMenuPlanta');
    const tituloMenu = document.getElementById('tituloMenu');
    const tituloPlanta = document.getElementById('tituloPlanta');
    const porcentagemPlanta = document.getElementById('porcentagemPlanta');
    const barraProgressoPlanta = document.getElementById('barraProgressoPlanta');
    const btnDesenvolver = document.getElementById('btnDesenvolver');
    const btnAcao = document.getElementById('btnAcao');
    
    // Elementos dos modais
    const modalCredito = document.getElementById('modalCredito');
    const modalInventario = document.getElementById('modalInventario');
    const modalReformar = document.getElementById('modalReformar');
    const modalSairAssentamento = document.getElementById('modalSairAssentamento');
    const modalConversa = document.getElementById('modalConversa');
    const modalComer = document.getElementById('modalComer');
    const telaDormir = document.getElementById('telaDormir');
    const progressoDormir = document.getElementById('progressoDormir');
    const telaGameOver = document.getElementById('telaGameOver');
    const motivoGameOver = document.getElementById('motivoGameOver');
    const telaFimEspecial = document.getElementById('telaFimEspecial');
    const mensagemFimEspecial = document.getElementById('mensagemFimEspecial');
    const gridInventario = document.getElementById('gridInventario');
    
    // Elementos de reforma
    const nivelBarracaAtual = document.getElementById('nivelBarracaAtual');
    const proximoNivelBarraca = document.getElementById('proximoNivelBarraca');
    const custoPorClique = document.getElementById('custoPorClique');
    const custoTotalReforma = document.getElementById('custoTotalReforma');
    const dinheiroAtualReforma = document.getElementById('dinheiroAtualReforma');
    const porcentagemReforma = document.getElementById('porcentagemReforma');
    const cliquesDados = document.getElementById('cliquesDados');
    const barraProgressoReforma = document.getElementById('barraProgressoReforma');
    const btnReformar = document.getElementById('btnReformar');
    
    // Alertas
    const alertaSucesso = document.getElementById('alertaSucesso');
    const alertaAviso = document.getElementById('alertaAviso');
    const alertaPerigo = document.getElementById('alertaPerigo');
    const mensagemSucesso = document.getElementById('mensagemSucesso');
    const mensagemAviso = document.getElementById('mensagemAviso');
    const mensagemPerigo = document.getElementById('mensagemPerigo');
    const tituloAviso = document.getElementById('tituloAviso');
    const tituloPerigo = document.getElementById('tituloPerigo');
    const emojiAviso = document.getElementById('emojiAviso');
    const emojiPerigo = document.getElementById('emojiPerigo');
    
    // Indicadores do jogo
    const nivelIndicador = document.getElementById('nivelIndicador');
    const nivelNumero = document.getElementById('nivelNumero');
    const dinheiroIndicador = document.getElementById('dinheiroIndicador');
    const dinheiroNumero = document.getElementById('dinheiroNumero');
    const casaIndicador = document.getElementById('casaIndicador');
    if (casaIndicador) {
        casaIndicador.style.display = 'none';
    }
    const casaNumero = document.getElementById('casaNumero');
    
    // Sistema de Indicadores
    const indicadorAlimentacao = document.getElementById('indicadorAlimentacao');
    const valorAlimentacao = document.getElementById('valorAlimentacao');
    const indicadorAgua = document.getElementById('indicadorAgua');
    const valorAgua = document.getElementById('valorAgua');
    const indicadorVinculo = document.getElementById('indicadorVinculo');
    const valorVinculo = document.getElementById('valorVinculo');
    const indicadorDescanso = document.getElementById('indicadorDescanso');
    const valorDescanso = document.getElementById('valorDescanso');
    
    // Elementos da navega√ß√£o
    const miniMapaBtn = document.getElementById('miniMapaBtn');
    const coordenadasDisplay = document.getElementById('coordenadasDisplay');
    const coordXElement = document.getElementById('coordX');
    const coordYElement = document.getElementById('coordY');
    
    // Slot de item selecionado no invent√°rio
    const slotSelecionadoContainer = document.getElementById('slotSelecionadoContainer');
    const slotSelecionadoEmoji = document.getElementById('slotSelecionadoEmoji');
    const slotSelecionadoNome = document.getElementById('slotSelecionadoNome');
    const slotSelecionadoTipo = document.getElementById('slotSelecionadoTipo');
    const slotSelecionadoQuantidade = document.getElementById('slotSelecionadoQuantidade');
    
    // Bot√µes do invent√°rio
    const btnConsumir = document.getElementById('btnConsumir');
    const btnUsar = document.getElementById('btnUsar');
    const btnVender = document.getElementById('btnVender');
    
    // Item em uso (canto inferior direito)
    const itemEmUso = document.getElementById('itemEmUso');
    const itemEmUsoEmoji = document.getElementById('itemEmUsoEmoji');
    const itemEmUsoNome = document.getElementById('itemEmUsoNome');
    
    // Modal de conversa
    const tituloConversa = document.getElementById('tituloConversa');
    const conteudoConversa = document.getElementById('conteudoConversa');
    const btnAnterior = document.getElementById('btnAnterior');
    const btnProximo = document.getElementById('btnProximo');
    
    // Modal Comer
    const listaAlimentos = document.getElementById('listaAlimentos');
    
    // Vari√°veis de controle
    let coordenadasVisiveis = false;
    let ultimaAtividade = Date.now();
    let inactivityTimer = null;
    let isLoading = false;

    // Sistema de √Åudio Cache
    let audioCache = {};
    
// NOVA FUN√á√ÉO: Dar cr√©dito INCRA + presentes
function darCreditoINCRA() {
    // Verificar se j√° recebeu
    if (localStorage.getItem('incra_credito_recebido') === 'true') {
        mostrarMensagemRapida('‚ö†Ô∏è Voc√™ j√° recebeu o Cr√©dito de Apoio Inicial!');
        return; // N√ÉO abre site
    }
    
    // 1. DAR DINHEIRO
    dinheiroJogador += 8000;
    
    // 2. DAR PRESENTES (ferramentas e alimentos)
    const presentes = [
        { emoji: "üî®", tipo: "ferramenta", nome: "Martelo", quantidade: 1 },
        { emoji: "ü™ì", tipo: "ferramenta", nome: "Machado", quantidade: 1 },
        { emoji: "‚õèÔ∏è", tipo: "ferramenta", nome: "Enxada", quantidade: 1 },
        { emoji: "üé£", tipo: "utensilio", nome: "Vara de Pesca", quantidade: 1 },
        { emoji: "üêõ", tipo: "alimento", nome: "Isca", quantidade: 1 },
        { emoji: "üç∂", tipo: "utensilio", nome: "Recipiente de √Ågua", quantidade: 1 },
        { emoji: "üî™", tipo: "ferramenta", nome: "Faca", quantidade: 1 },
        { emoji: "üçÖ", tipo: "alimento", nome: "Tomate", quantidade: 6 },
        { emoji: "ü•î", tipo: "alimento", nome: "Batata", quantidade: 8 },
        { emoji: "ü•ï", tipo: "alimento", nome: "Cenoura", quantidade: 7 },
        { emoji: "üåΩ", tipo: "alimento", nome: "Milho", quantidade: 10 }
    ];
    
    // Adicionar itens ao invent√°rio
    let slotsUsados = 0;
    let itensNaoCabem = 0;
    
    presentes.forEach(presente => {
        // Encontrar slot vazio
        const slotVazio = inventario.findIndex(item => item === null);
        
        if (slotVazio !== -1 && slotsUsados < 12) {
            inventario[slotVazio] = {
                emoji: presente.emoji,
                tipo: presente.tipo,
                nome: presente.nome,
                quantidade: presente.quantidade
            };
            slotsUsados++;
        } else {
            // Tentar adicionar a itens existentes do mesmo tipo
            const itemExistente = inventario.findIndex(item => 
                item && item.nome === presente.nome
            );
            
            if (itemExistente !== -1) {
                inventario[itemExistente].quantidade += presente.quantidade;
            } else {
                itensNaoCabem++;
            }
        }
    });
    
    // Equipar o martelo automaticamente
    const indexMartelo = inventario.findIndex(item => item && item.nome === "Martelo");
    if (indexMartelo !== -1) {
        itemEmUsoAtual = {
            emoji: "üî®",
            nome: "Martelo",
            tipo: "ferramenta",
            index: indexMartelo
        };
        atualizarSlotEquipamentoExterno();
    }
    
    // 3. MARCAR COMO RECEBIDO
    localStorage.setItem('incra_credito_recebido', 'true');
    
    // 4. ATUALIZAR INTERFACE
    atualizarInventario();
    atualizarIndicadores();
    
    // 5. MOSTRAR MENSAGEM DE SUCESSO
    mostrarAlertaSucesso(`üí∞ Voc√™ acaba de ganhar um Cr√©dito de Apoio Inicial do INCRA + Kit de Ferramentas e Alimentos! 
(Veja no: üéí Invent√°rio, clicando no seu barraco.)`);
    
    // 6. N√ÉO ABRE MAIS O SITE DO INCRA AUTOMATICAMENTE
    // (coment√°rio: o jogador pode acessar manualmente se quiser)
    
    // 7. SOM DE SUCESSO
    tocarSom('somSucesso');
    tocarSom('somDinheiro');
    
    // 8. AVISO SE ALGUNS ITENS N√ÉO COUBERAM
    if (itensNaoCabem > 0) {
        setTimeout(() => {
            mostrarMensagemRapida(`‚ö†Ô∏è ${itensNaoCabem} itens n√£o couberam no invent√°rio! Libere espa√ßo.`);
        }, 3000);
    }
}

    // Fun√ß√£o para formatar a palavra Assentamento com emoji
    function formatarAssentamento(texto) {
        return texto.replace(/Assentamento/gi, 'üö© Assentamento');
    }

    let canvasW = window.innerWidth;
    let canvasH = window.innerHeight;
    canvas.width = canvasW;
    canvas.height = canvasH;

// ============================================
// SISTEMA DE REFORMA DA CASA
// ============================================

// Vari√°veis de controle da reforma
let nivelCasaPersonagem = 0; // N√≠vel atual da casa (come√ßa no 0)
let progressoReforma = 0; // Progresso atual da reforma (0-100%)
let totalCliquesNecessarios = 20; // Cliques necess√°rios para completar 100%
let custoBasePorNivel = 10; // Multiplicador para o custo por clique

// Imagens da casa do personagem por n√≠vel (√≠ndice 0 = n√≠vel 0, √≠ndice 1 = n√≠vel 1, etc.)
const imagensCasaPersonagem = [
    'https://imgur.com/hh1RSDK.png', // N√≠vel 0 (inicial)
    'https://i.imgur.com/2JVqUuk.png', // N√≠vel 1
    'https://imgur.com/IwuChUC.png', // N√≠vel 2
    'https://imgur.com/5sTzoyW.png', // N√≠vel 3
    'https://imgur.com/dYYZ7pd.png', // N√≠vel 4
    'https://imgur.com/04VyPyT.png', // N√≠vel 5
    'https://imgur.com/NrZwAO2.png', // N√≠vel 6
    'https://imgur.com/EfCO4g0.png', // N√≠vel 7
    'https://imgur.com/q7pkdko.png', // N√≠vel 8
    'https://imgur.com/lPzrB66.png'  // N√≠vel 9
    // N√≠vel 10 seria o √≠ndice 10 se adicionar mais uma imagem
];

// Imagens das lideran√ßas por n√≠vel da casa do personagem
// Verifique se estas URLs est√£o corretas:
const imagensLiderancaPorNivel = {
    0: { 
        normal: 'https://i.imgur.com/n8Ra9nA.png', 
        conversa: 'https://i.imgur.com/grjItgs.png' 
    },
    1: { 
        normal: 'https://imgur.com/VdJedY9.png', 
        conversa: 'https://imgur.com/5sZDsAq.png' 
    },
    2: { 
        normal: 'https://imgur.com/k5NHqRX.png', 
        conversa: 'https://imgur.com/9lax4bF.png' 
    },
    3: { 
        normal: 'https://imgur.com/cx2KLZ8.png', 
        conversa: 'https://imgur.com/EUUeBg0.png' 
    },
    // Para n√≠veis 4 em diante, usar as mesmas do n√≠vel 3
    4: { normal: 'https://imgur.com/cx2KLZ8.png', conversa: 'https://imgur.com/EUUeBg0.png' },
    5: { normal: 'https://imgur.com/cx2KLZ8.png', conversa: 'https://imgur.com/EUUeBg0.png' },
    6: { normal: 'https://imgur.com/cx2KLZ8.png', conversa: 'https://imgur.com/EUUeBg0.png' },
    7: { normal: 'https://imgur.com/cx2KLZ8.png', conversa: 'https://imgur.com/EUUeBg0.png' },
    8: { normal: 'https://imgur.com/cx2KLZ8.png', conversa: 'https://imgur.com/EUUeBg0.png' },
    9: { normal: 'https://imgur.com/cx2KLZ8.png', conversa: 'https://imgur.com/EUUeBg0.png' }
};

// Imagens dos vizinhos por n√≠vel da casa do personagem
// Imagens dos vizinhos por n√≠vel da casa do personagem - ATUALIZADO
const imagensVizinhosPorNivel = {
    0: Array(8).fill('https://i.imgur.com/nVKBTjy.png'), // N√≠vel 0 - todas iguais
    1: Array(8).fill('https://imgur.com/om7XctV.png'),   // N√≠vel 1 - todas iguais
    2: [ // N√≠vel 2+ - cada fam√≠lia diferente
        'https://imgur.com/z9gMLJF.png', // Fam√≠lia Silva (B2)
        'https://imgur.com/4azd29w.png', // Fam√≠lia Santos (B3)
        'https://imgur.com/mmpN4dl.png', // Fam√≠lia Oliveira (B4)
        'https://imgur.com/mV2QTrj.png', // Fam√≠lia Souza (B5)
        'https://imgur.com/TzBC1JY.png', // Fam√≠lia Pereira (B6)
        'https://imgur.com/z9gMLJF.png', // Fam√≠lia Ferreira (B7) - padr√£o
        'https://imgur.com/z9gMLJF.png', // Fam√≠lia Lima (B8) - padr√£o
        'https://imgur.com/w1m6PSx.png'  // Fam√≠lia Alves (B9)
    ]
    // Para n√≠veis 3 em diante, manter as mesmas imagens do n√≠vel 2
};

// Array global para armazenar as imagens dos vizinhos
const imagesVizinhos = Array(8).fill(null);


    // Configura√ß√£o de imagens
    const images = {
        background: new Image(),
        lideranca: new Image(),
        liderancaConversa: new Image(),
        barracoFamiliar: new Image(),
        barracoPersonagem: new Image(),
        acude: new Image(),
        // Pai (ativo por padr√£o)
        idleUp: new Image(),
        idleDown: new Image(),
        idleLeft: new Image(),
        idleRight: new Image(),
        walkLeft1: new Image(),
        walkLeft2: new Image(),
        walkRight1: new Image(),
        walkRight2: new Image(),
        walkUp1: new Image(),
        walkUp2: new Image(),
        walkDown1: new Image(),
        walkDown2: new Image(),
        // M√£e
        mae_idleUp: new Image(),
        mae_idleDown: new Image(),
        mae_idleLeft: new Image(),
        mae_idleRight: new Image(),
        mae_walkLeft1: new Image(),
        mae_walkLeft2: new Image(),
        mae_walkRight1: new Image(),
        mae_walkRight2: new Image(),
        mae_walkUp1: new Image(),
        mae_walkUp2: new Image(),
        mae_walkDown1: new Image(),
        mae_walkDown2: new Image(),
        // Filho
        filho_idleUp: new Image(),
        filho_idleDown: new Image(),
        filho_idleLeft: new Image(),
        filho_idleRight: new Image(),
        filho_walkLeft1: new Image(),
        filho_walkLeft2: new Image(),
        filho_walkRight1: new Image(),
        filho_walkRight2: new Image(),
        filho_walkUp1: new Image(),
        filho_walkUp2: new Image(),
        filho_walkDown1: new Image(),
        filho_walkDown2: new Image()
    };

    // URLs atualizadas para Imgur (iniciais)
    const imageUrls = {
        background: 'https://i.imgur.com/IOqwmNC.png',
        lideranca: 'https://i.imgur.com/n8Ra9nA.png',
        liderancaConversa: 'https://i.imgur.com/grjItgs.png',
        barracoFamiliar: 'https://i.imgur.com/nVKBTjy.png',
        barracoPersonagem: 'https://imgur.com/hh1RSDK.png',
        acude: 'https://i.imgur.com/zmyG8QX.png',
        // Pai (ativo por padr√£o)
        idleUp: 'https://i.imgur.com/MpBlUdk.png',
        idleDown: 'https://i.imgur.com/VIxRCsn.png',
        idleLeft: 'https://i.imgur.com/I5a9Tkn.png',
        idleRight: 'https://i.imgur.com/5lMKoPt.png',
        walkLeft1: 'https://i.imgur.com/58DYX9T.png',
        walkLeft2: 'https://i.imgur.com/4SIOoVN.png',
        walkRight1: 'https://i.imgur.com/7LMx2iK.png',
        walkRight2: 'https://i.imgur.com/Q9dYU2l.png',
        walkUp1: 'https://i.imgur.com/LWtDgz9.png',
        walkUp2: 'https://i.imgur.com/450SLWi.png',
        walkDown1: 'https://i.imgur.com/6ltLTPy.png',
        walkDown2: 'https://i.imgur.com/DVz49nm.png',
        // M√£e
        mae_idleUp: 'https://imgur.com/pgvqc4R.png',
        mae_idleDown: 'https://imgur.com/zJvyBgP.png',
        mae_idleLeft: 'https://imgur.com/zOBLOol.png',
        mae_idleRight: 'https://imgur.com/hU3AoXR.png',
        mae_walkLeft1: 'https://imgur.com/vhgS64i.png',
        mae_walkLeft2: 'https://imgur.com/R4bBzNE.png',
        mae_walkRight1: 'https://imgur.com/pokRAbS.png',
        mae_walkRight2: 'https://imgur.com/jjb8fLa.png',
        mae_walkUp1: 'https://imgur.com/tGe3dcf.png',
        mae_walkUp2: 'https://imgur.com/qhRGSvN.png',
        mae_walkDown1: 'https://imgur.com/eLKYPRH.png',
        mae_walkDown2: 'https://imgur.com/QMLwzoF.png',
        // Filho
        filho_idleUp: 'https://imgur.com/z5A0mPv.png',
        filho_idleDown: 'https://imgur.com/aUHGu8S.png',
        filho_idleLeft: 'https://imgur.com/qlptyzj.png',
        filho_idleRight: 'https://imgur.com/NbApHMz.png',
        filho_walkLeft1: 'https://imgur.com/DWPWCDr.png',
        filho_walkLeft2: 'https://imgur.com/Rk5XOw4.png',
        filho_walkRight1: 'https://imgur.com/AaglwFD.png',
        filho_walkRight2: 'https://imgur.com/fJWNMlw.png',
        filho_walkUp1: 'https://imgur.com/KvrP6KZ.png',
        filho_walkUp2: 'https://imgur.com/SdxL71x.png',
        filho_walkDown1: 'https://imgur.com/POlCx04.png',
        filho_walkDown2: 'https://imgur.com/grXzkGe.png'
    };

    // Dimens√µes das imagens
    const imageDimensions = {
        idleUp: { width: 0, height: 0, loaded: false },
        idleDown: { width: 0, height: 0, loaded: false },
        idleLeft: { width: 0, height: 0, loaded: false },
        idleRight: { width: 0, height: 0, loaded: false },
        walkLeft1: { width: 0, height: 0, loaded: false },
        walkLeft2: { width: 0, height: 0, loaded: false },
        walkRight1: { width: 0, height: 0, loaded: false },
        walkRight2: { width: 0, height: 0, loaded: false },
        walkUp1: { width: 0, height: 0, loaded: false },
        walkUp2: { width: 0, height: 0, loaded: false },
        walkDown1: { width: 0, height: 0, loaded: false },
        walkDown2: { width: 0, height: 0, loaded: false },
        // M√£e
        mae_idleUp: { width: 0, height: 0, loaded: false },
        mae_idleDown: { width: 0, height: 0, loaded: false },
        mae_idleLeft: { width: 0, height: 0, loaded: false },
        mae_idleRight: { width: 0, height: 0, loaded: false },
        mae_walkLeft1: { width: 0, height: 0, loaded: false },
        mae_walkLeft2: { width: 0, height: 0, loaded: false },
        mae_walkRight1: { width: 0, height: 0, loaded: false },
        mae_walkRight2: { width: 0, height: 0, loaded: false },
        mae_walkUp1: { width: 0, height: 0, loaded: false },
        mae_walkUp2: { width: 0, height: 0, loaded: false },
        mae_walkDown1: { width: 0, height: 0, loaded: false },
        mae_walkDown2: { width: 0, height: 0, loaded: false },
        // Filho
        filho_idleUp: { width: 0, height: 0, loaded: false },
        filho_idleDown: { width: 0, height: 0, loaded: false },
        filho_idleLeft: { width: 0, height: 0, loaded: false },
        filho_idleRight: { width: 0, height: 0, loaded: false },
        filho_walkLeft1: { width: 0, height: 0, loaded: false },
        filho_walkLeft2: { width: 0, height: 0, loaded: false },
        filho_walkRight1: { width: 0, height: 0, loaded: false },
        filho_walkRight2: { width: 0, height: 0, loaded: false },
        filho_walkUp1: { width: 0, height: 0, loaded: false },
        filho_walkUp2: { width: 0, height: 0, loaded: false },
        filho_walkDown1: { width: 0, height: 0, loaded: false },
        filho_walkDown2: { width: 0, height: 0, loaded: false }
    };

    // Configura√ß√£o das estruturas
    const barracaConfig = {
        width: 200,
        height: 200,
        spacing: 0,
        verticalSpacing: 200,
        startX: 300,
        startY: 200
    };

    const nomesEstruturas = [
        "Lideran√ßas do Assentamento",
        "üë®‚Äçüë©‚Äçüë¶ Fam√≠lia Silva",
        "üë®‚Äçüë©‚Äçüëß Fam√≠lia Santos",
        "üë®‚Äçüë¶ Fam√≠lia Oliveira",
        "üë®‚Äçüë¶‚Äçüë¶ Fam√≠lia Souza",
        "üë®‚Äçüëß‚Äçüëß Fam√≠lia Pereira",
        "üë®‚Äçüë¶ Fam√≠lia Ferreira",
        "üë®‚Äçüë©‚Äçüë¶ Fam√≠lia Lima",
        "üë©‚Äçüë¶‚Äçüë¶ Fam√≠lia Alves",
        "üë™ Sua Casa"
    ];

    const estruturas = [];
    let estruturaAtualSelecionada = -1;

    // Plantas e novos elementos (REMOVIDOS os seletores de personagem do mapa)
    let emojisFixos = [
        { emoji: 'üå±', x: 1500, y: 850, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 0, tipo: 'planta' },
        { emoji: 'üå±', x: 1550, y: 850, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 1, tipo: 'planta' },
        { emoji: 'üå±', x: 1600, y: 850, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 2, tipo: 'planta' },
        { emoji: 'üå±', x: 1500, y: 900, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 3, tipo: 'planta' },
        { emoji: 'üå±', x: 1550, y: 900, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 11) + 10, ativa: true, id: 4, tipo: 'planta' },
        { emoji: 'üå±', x: 1600, y: 900, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 11) + 10, ativa: true, id: 5, tipo: 'planta' },
        { emoji: 'üå±', x: 1500, y: 950, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 11) + 10, ativa: true, id: 6, tipo: 'planta' },
        { emoji: 'üå±', x: 1550, y: 950, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 11) + 10, ativa: true, id: 7, tipo: 'planta' },
        { emoji: 'üå±', x: 1600, y: 950, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 11) + 10, ativa: true, id: 8, tipo: 'planta' },
        // √Årvore
        { emoji: 'üå≥', x: -104, y: 596, size: 200, color: '#228B22', isHovered: false, porcentagem: 100, ativa: true, id: 9, tipo: 'arvore', tempoUltimaColeta: 0, posicoesTriangulo: null },
        // Galinha
{ emoji: 'üêì', x: 1550, y: 700, size: 40, color: '#FFD700', isHovered: false, porcentagem: 50, ativa: true, id: 10, tipo: 'galinha', tempoUltimaPostura: 0, posicoesTriangulo: null, indicePosicao: 0 },
// Broto (para reflorestamento)
{ emoji: 'üå≥', x: 1700, y: 650, size: 60, color: '#90EE90', isHovered: false, porcentagem: 10, ativa: false, id: 11, tipo: 'broto', tempoUltimaColeta: 0, posicoesTriangulo: null }
    ];

    let plantaSelecionada = -1;
    let nivelJogador = 1;
    let dinheiroJogador = 0;
    let plantasTransformadas = 0;
    // INVENT√ÅRIO ATUALIZADO: 12 slots (4x3)
    let inventario = Array(12).fill(null);
    let creditoSelecionado = -1;
    let itemSelecionadoIndex = -1;
    let itemEmUsoAtual = null;
    
    // Vari√°vel para controle do primeiro contato
    let primeiroContatoLideranca = true;
    
    // Vari√°veis de jogo
    let ultimoAlerta = {
        alimentacao: false,
        agua: false,
        vinculo: false,
        descanso: false
    };
    
    // Vari√°veis para controle de conversa
    let conversaAtual = [];
    let paginaConversaAtual = 0;
    let estruturaConversaAtual = -1;
    let liderancaImagemAlterada = false;

    // Estado do jogo
    let cameraX = 0;
    let cameraY = 0;
    let lastTime = 0;
    let currentWalkFrame = 0;
    let walkFrameTimer = 0;
    let lastDirection = 'down';
    let mouseX = 0;
    let mouseY = 0;
    let gameOver = false;
    let jogoCarregado = false;
    
    // Personagem atual
    let personagemAtual = 'pai';

    const CHARACTER_SIZE = {
        baseWidth: 120,
        baseHeight: 160
    };

    const player = {
        x: canvasW / 2,
        y: canvasH / 2,
        targetX: canvasW / 2,
        targetY: canvasH / 2,
        speed: 2.5,
        isMoving: false,
        width: 0,
        height: 0
    };

    // Configura√ß√µes da anima√ß√£o
    const ANIMATION_SPEED = 200;

    // ============================================
    // FUN√á√ïES DO SISTEMA DE REFORMA
    // ============================================
    
    // Fun√ß√£o para abrir o modal de reforma
    function abrirModalReformar() {
        atualizarInformacoesReforma();
        modalReformar.style.display = 'block';
        tocarSom('somClique');
    }
    
    // Atualiza as informa√ß√µes no modal de reforma
function atualizarInformacoesReforma() {
    document.getElementById('nivelBarracaAtual').textContent = nivelCasaPersonagem;
    document.getElementById('proximoNivelBarraca').textContent = nivelCasaPersonagem + 1;
    
    // Custo por clique = (n√≠vel atual + 1) * 50
    const custoPorCliqueCalculado = (nivelCasaPersonagem + 1) * 50;
    document.getElementById('custoPorClique').textContent = custoPorCliqueCalculado;
    
    // Custo total = custo por clique * 20
    const custoTotal = custoPorCliqueCalculado * 20;
    document.getElementById('custoTotalReforma').textContent = custoTotal;
    
    document.getElementById('dinheiroAtualReforma').textContent = dinheiroJogador;
    
    // Progresso
    document.getElementById('porcentagemReforma').textContent = progressoReforma;
    const cliquesDadosCalculado = Math.floor(progressoReforma / 5);
    document.getElementById('cliquesDados').textContent = cliquesDadosCalculado;
    
    // Barra de progresso
    const barra = document.getElementById('barraProgressoReforma');
    barra.style.width = progressoReforma + '%';
    barra.textContent = progressoReforma + '%';
    
    // Mudar cor da barra conforme progresso
    if (progressoReforma >= 100) {
        barra.style.background = 'linear-gradient(90deg, #32CD32, #228B22)';
        document.getElementById('btnReformar').textContent = 'üéâ Completar Reforma';
    } else if (progressoReforma >= 70) {
        barra.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
    } else if (progressoReforma >= 40) {
        barra.style.background = 'linear-gradient(90deg, #D2691E, #8B4513)';
    }
}    
    // Fun√ß√£o chamada ao clicar no bot√£o de reformar
function iniciarReforma() {
    // Verificar se o martelo est√° equipado
    if (!itemEmUsoAtual || itemEmUsoAtual.nome !== "Martelo") {
        mostrarMensagemRapida("Voc√™ precisa usar üî® Martelo para reformar!");
        fecharModal('modalReformar');
        return;
    }
    
    // Se o progresso j√° estiver em 100%, completar a reforma
    if (progressoReforma >= 100) {
        completarReforma();
        return;
    }
    
    // Calcular custo por clique = (n√≠vel atual + 1) * 50
    const custoPorCliqueCalculado = (nivelCasaPersonagem + 1) * 50;
    
    // Verificar se tem dinheiro suficiente
    if (dinheiroJogador < custoPorCliqueCalculado) {
        mostrarMensagemRapida(`üí∞ Dinheiro insuficiente! Plante e venda mais!`);
        fecharModal('modalReformar');
        return;
    }
    
    // Verificar recursos do sistema de indicadores
    if (SistemaIndicadores.estado.agua < 0.02 || 
        SistemaIndicadores.estado.alimentacao < 0.015 ||
        SistemaIndicadores.estado.descanso < 0.01) {
        mostrarMensagemRapida('Recursos insuficientes para desenvolver a planta!');
        return;
    }
    
    // Mostrar efeito do martelo
    mostrarEfeitoFerramenta();
    
    // Consumir recursos
    SistemaIndicadores.consumirRecursos(0.02, 0.015, 0.01); // 2% √°gua, 1.5% fome, 1% descanso
    
    // Deduzir dinheiro
    dinheiroJogador -= custoPorCliqueCalculado;
    
    // Aumentar progresso em 5%
    progressoReforma += 5;
    
    // Se passou de 100%, ajustar para 100
    if (progressoReforma > 100) progressoReforma = 100;
    
    // Atualizar informa√ß√µes no modal
    atualizarInformacoesReforma();
    
    // Atualizar indicadores do jogo
    atualizarIndicadores();
    
    // Salvar jogo
    salvarJogo();
    
    // Mensagem de feedback
    if (progressoReforma >= 100) {
        mostrarMensagemRapida(`üè† Reforma conclu√≠da! Clique novamente para subir de n√≠vel.`);
    } else {
        mostrarMensagemRapida(`üî® Reformando... Progresso: ${progressoReforma}% (-R$ ${custoPorCliqueCalculado*50})`);
    }
    
    tocarSom('somPlanta');
}    
    // Fun√ß√£o para completar a reforma e subir de n√≠vel
    function completarReforma() {
        // Aumentar n√≠vel da casa
        nivelCasaPersonagem++;
        
        // Aumentar n√≠vel do jogador (LV geral)
        nivelJogador++;
        
        // Resetar progresso para o pr√≥ximo n√≠vel
        progressoReforma = 0;
        
   // Atualizar imagem da casa do personagem E dos vizinhos
    atualizarImagensEstruturas();
    
    // For√ßar atualiza√ß√£o das imagens dos vizinhos
    forcarAtualizacaoVizinhos();
        
        // Ajustar dimens√µes e posi√ß√µes das casas a partir do n√≠vel 5
        if (nivelCasaPersonagem >= 5) {
            ajustarDimensoesCasas();
        }
        
        // Mostrar mensagem de sucesso
        mostrarAlertaSucesso(`üè† PARAB√âNS! Sua casa agora √© N√≠vel ${nivelCasaPersonagem}!`);
        
        // Fechar modal de reforma
        fecharModal('modalReformar');
        
        // Atualizar indicadores
        atualizarIndicadores();
        
        // Salvar jogo
        salvarJogo();
        
        tocarSom('somSucesso');
    }
    
    // Ajustar dimens√µes das casas a partir do n√≠vel 5
    function ajustarDimensoesCasas() {
        // Aumentar o espa√ßamento entre as casas em 10 pixels
        barracaConfig.spacing += 10;
        barracaConfig.verticalSpacing += 10;
        
        // Recalcular posi√ß√µes das estruturas
        criarEstruturas();
    }
    
// Atualizar imagens das estruturas conforme n√≠vel da casa
function atualizarImagensEstruturas() {
    // Atualizar imagem da casa do personagem
    if (nivelCasaPersonagem >= 0 && nivelCasaPersonagem < imagensCasaPersonagem.length) {
        images.barracoPersonagem.src = imagensCasaPersonagem[nivelCasaPersonagem];
    }
    
    // Atualizar imagens das lideran√ßas
    let nivelLideranca = nivelCasaPersonagem;
    if (nivelLideranca > 3) nivelLideranca = 3;
    
    if (imagensLiderancaPorNivel[nivelLideranca]) {
        images.lideranca.src = imagensLiderancaPorNivel[nivelLideranca].normal;
        images.liderancaConversa.src = imagensLiderancaPorNivel[nivelLideranca].conversa;
    }
    
    // Atualizar imagens dos vizinhos (barraco_familiar)
    carregarImagensVizinhos();
    
    // Recarregar as imagens principais
    Object.keys(images).forEach(key => {
        if (images[key].complete) {
            // Disparar evento onload manualmente para recalcular dimens√µes
            const img = new Image();
            img.src = images[key].src;
            img.onload = images[key].onload;
        }
    });
}

    
    // Carregar imagens dos vizinhos para n√≠vel 3+
// Carregar imagens dos vizinhos para n√≠vel 2+
function carregarImagensVizinhos() {
    if (nivelCasaPersonagem >= 2) {
        const imagens = imagensVizinhosPorNivel[2];
        if (imagens && Array.isArray(imagens)) {
            for (let i = 0; i < imagens.length; i++) {
                if (!imagesVizinhos[i]) {
                    imagesVizinhos[i] = new Image();
                    imagesVizinhos[i].src = imagens[i];
                    
                    // Adicionar evento onload para garantir carregamento
                    imagesVizinhos[i].onload = function() {
                        console.log(`Imagem do vizinho ${i} carregada: ${imagens[i]}`);
                    };
                    
                    imagesVizinhos[i].onerror = function() {
                        console.error(`Erro ao carregar imagem do vizinho ${i}: ${imagens[i]}`);
                        // Fallback para imagem padr√£o
                        imagesVizinhos[i].src = imageUrls.barracoFamiliar;
                    };
                } else if (imagesVizinhos[i].src !== imagens[i]) {
                    // Se j√° existe mas √© imagem diferente, atualizar
                    imagesVizinhos[i].src = imagens[i];
                }
            }
        }
    } else {
        // Para n√≠veis 0 e 1, usar imagem padr√£o para todos
        for (let i = 0; i < 8; i++) {
            if (!imagesVizinhos[i]) {
                imagesVizinhos[i] = new Image();
                const imagem = nivelCasaPersonagem === 0 ? 
                    imagensVizinhosPorNivel[0][i] : 
                    imagensVizinhosPorNivel[1][i];
                imagesVizinhos[i].src = imagem;
            }
        }
    }
}


    // Sistema de Indicadores Simplificado
const SistemaIndicadores = {
    config: {
        cliqueValor: 0.01,         // 1% por clique
        movimentoValor: 0.005,     // ‚≠ê MANT√âM 0,5% por movimento
        alimentacaoValor: 0.01,    // ‚≠ê 1% por unidade (para alimentos)
        aguaValor: 0.01,           // ‚≠ê 1% por unidade (para √°gua)
        vinculoValor: 0.01,
        descansoValor: 0.01,
        penalidadeValor: 0.01
    },        
        estado: {
            alimentacao: 1.0,
            agua: 1.0,
            vinculo: 0.1,
            descanso: 1.0,
            cliques: 0,
            movimentos: 0,
            ultimaAtualizacao: Date.now()
        },
        
        init: function() {
            this.atualizarInterface();
            this.iniciarMonitoramento();
        },
        
        atualizarInterface: function() {
            const formatarPercentual = (valor) => Math.round(valor * 100) + '%';
            
            // Atualizar valores
            valorAlimentacao.textContent = formatarPercentual(this.estado.alimentacao);
            valorAgua.textContent = formatarPercentual(this.estado.agua);
            valorVinculo.textContent = formatarPercentual(this.estado.vinculo);
            valorDescanso.textContent = formatarPercentual(this.estado.descanso);
            
            // Verificar se est√° baixo e adicionar anima√ß√£o
            this.verificarIndicadoresBaixos();
            
            // Verificar alertas cr√≠ticos
            this.verificarAlertasCriticos();
            
            // Verificar game over
            this.verificarGameOver();
        },
        
        verificarIndicadoresBaixos: function() {
            // Remover anima√ß√µes anteriores
            indicadorAlimentacao.classList.remove('indicador-baixo', 'indicador-critico');
            indicadorAgua.classList.remove('indicador-baixo', 'indicador-critico');
            indicadorVinculo.classList.remove('indicador-baixo', 'indicador-critico');
            indicadorDescanso.classList.remove('indicador-baixo', 'indicador-critico');
            
            // Adicionar anima√ß√£o para indicadores baixos
            const indicadores = [
                { id: 'alimentacao', valor: this.estado.alimentacao, elemento: indicadorAlimentacao },
                { id: 'agua', valor: this.estado.agua, elemento: indicadorAgua },
                { id: 'vinculo', valor: this.estado.vinculo, elemento: indicadorVinculo },
                { id: 'descanso', valor: this.estado.descanso, elemento: indicadorDescanso }
            ];
            
            indicadores.forEach(ind => {
                if (ind.valor < 0.1) {
                    ind.elemento.classList.add('indicador-critico');
        fecharModal('modalReformar');
                } else if (ind.valor < 0.3) {
                    ind.elemento.classList.add('indicador-baixo');
                }
            });
        },
        
        verificarAlertasCriticos: function() {
            const agora = Date.now();
            const indicadoresCriticos = [];
            
            if (this.estado.alimentacao < 0.1 && !ultimoAlerta.alimentacao) {
                indicadoresCriticos.push('Fome extrema! Voc√™ precisa se alimentar imediatamente!');
                ultimoAlerta.alimentacao = true;
                mostrarAlerta('üçΩÔ∏è', 'FOME EXTREMA!', 'Voc√™ est√° morrendo de fome! Alimente-se agora!');
            } else if (this.estado.alimentacao >= 0.1) {
                ultimoAlerta.alimentacao = false;
            }
            
            if (this.estado.agua < 0.1 && !ultimoAlerta.agua) {
                indicadoresCriticos.push('PRECISA DE √ÅGUA! Corra para coletar mais √°gua no a√ßude!');
                ultimoAlerta.agua = true;
                mostrarAlerta('üíß', 'PRECISA DE √ÅGUA!', 'Corra para coletar mais √°gua no a√ßude!');
            } else if (this.estado.agua >= 0.1) {
                ultimoAlerta.agua = false;
            }
            
            if (this.estado.vinculo < 0.1 && !ultimoAlerta.vinculo) {
                indicadoresCriticos.push('Isolamento social! Voc√™ precisa interagir com a comunidade!');
                ultimoAlerta.vinculo = true;
                mostrarAlerta('ü§ù', 'ISOLAMENTO SOCIAL!', 'Voc√™ est√° muito isolado! Interaja com a comunidade!');
            } else if (this.estado.vinculo >= 0.1) {
                ultimoAlerta.vinculo = false;
            }
            
            if (this.estado.descanso < 0.1 && !ultimoAlerta.descanso) {
                indicadoresCriticos.push('Exaust√£o! Voc√™ precisa dormir imediatamente!');
                ultimoAlerta.descanso = true;
                mostrarAlerta('üí§', 'EXAUST√ÉO!', 'Voc√™ est√° exausto! Durma agora para recuperar energia!');
            } else if (this.estado.descanso >= 0.1) {
                ultimoAlerta.descanso = false;
            }
        },
        
        verificarGameOver: function() {
            if (gameOver) return;
            
            let motivo = '';
            
            if (this.estado.alimentacao <= 0) {
                motivo = 'Fome extrema levou ao desmaio e falecimento.';
                this.gameOver(motivo);
            } else if (this.estado.agua <= 0) {
                motivo = 'Desidrata√ß√£o extrema causou fal√™ncia m√∫ltipla de √≥rg√£os.';
                this.gameOver(motivo);
            } else if (this.estado.vinculo <= 0) {
                motivo = 'Isolamento social total levou √† depress√£o profunda.';
                this.gameOver(motivo);
            } else if (this.estado.descanso <= 0) {
                motivo = 'Exaust√£o total causou colapso f√≠sico e mental.';
                this.gameOver(motivo);
            }
        },
        
        gameOver: function(motivo) {
            gameOver = true;
            motivoGameOver.textContent = formatarAssentamento(motivo);
            telaGameOver.style.display = 'flex';
            tocarSom('somGameOver');
            
            // Limpar todos os dados salvos
            localStorage.removeItem('assentamentoRural_save');
            localStorage.removeItem('assentamentoRural_backup');
            localStorage.removeItem('lideranca_contato_inicial');
        },
        
        iniciarMonitoramento: function() {
            setInterval(() => {
                if (gameOver) return;
                
                const agora = Date.now();
                const tempoPassado = agora - this.estado.ultimaAtualizacao;
                const reducao = tempoPassado / 60000;
                
                // DEGRADA√á√ÉO - Reduzir todos os indicadores ao longo do tempo
                ['alimentacao', 'agua', 'vinculo', 'descanso'].forEach(id => {
                    this.estado[id] = Math.max(0, this.estado[id] - (reducao * 0.005)); // ‚≠ê 0,5% por minuto
                });
                
                this.estado.ultimaAtualizacao = agora;
                this.atualizarInterface();
            }, 10000);
        },
        
        registrarClique: function() {
            this.estado.cliques++;
            this.estado.vinculo = Math.min(1, this.estado.vinculo + this.config.cliqueValor);
            this.atualizarInterface();
        },
        
        registrarMovimento: function() {
            this.estado.movimentos++;
            this.estado.alimentacao = Math.max(0, this.estado.alimentacao - this.config.movimentoValor);
            this.estado.agua = Math.max(0, this.estado.agua - this.config.movimentoValor);
            this.estado.descanso = Math.max(0, this.estado.descanso - this.config.movimentoValor * 0.5);
            this.estado.vinculo = Math.min(1, this.estado.vinculo + this.config.movimentoValor * 0.5);
            this.atualizarInterface();
        },
        
        aumentarAlimentacao: function(quantidade = 1) {
            const aumento = quantidade * this.config.alimentacaoValor;
            this.estado.alimentacao = Math.min(1, this.estado.alimentacao + aumento);
            
            this.efeitoVisual('alimentacao', '+');
            this.atualizarInterface();
        },
        
        aumentarAgua: function(quantidade = 1) {
            const aumento = quantidade * this.config.aguaValor;
            this.estado.agua = Math.min(1, this.estado.agua + aumento);
            
            this.efeitoVisual('agua', '+');
            this.atualizarInterface();
        },
        
        aumentarVinculo: function(quantidade = 1) {
            const aumento = quantidade * this.config.vinculoValor;
            this.estado.vinculo = Math.min(1, this.estado.vinculo + aumento);
            
            this.efeitoVisual('vinculo', '+');
            this.atualizarInterface();
        },
        
        aumentarDescanso: function(quantidade = 1) {
            const aumento = quantidade * this.config.descansoValor;
            this.estado.descanso = Math.min(1, this.estado.descanso + aumento);
            
            this.efeitoVisual('descanso', '+');
            this.atualizarInterface();
        },
        
        reduzirVinculo: function(quantidade = 1) {
            const reducao = quantidade * this.config.penalidadeValor;
            this.estado.vinculo = Math.max(0, this.estado.vinculo - reducao);
            
            this.efeitoVisual('vinculo', '-');
            this.atualizarInterface();
        },
        
        consumirRecursos: function(agua = 0, alimentacao = 0, descanso = 0) {
            this.estado.agua = Math.max(0, this.estado.agua - agua);
            this.estado.alimentacao = Math.max(0, this.estado.alimentacao - alimentacao);
            this.estado.descanso = Math.max(0, this.estado.descanso - descanso);
            this.atualizarInterface();
        },
        
        efeitoVisual: function(tipo, operacao) {
            const elemento = document.getElementById(`indicador${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            if (!elemento) return;
            
            elemento.style.transform = 'scale(1.2)';
            elemento.style.transition = 'transform 0.2s';
            
            setTimeout(() => {
                elemento.style.transform = 'scale(1)';
            }, 200);
        },
        
        getEstadoGeral: function() {
            const media = (this.estado.alimentacao + this.estado.agua + this.estado.vinculo + this.estado.descanso) / 4;
            if (media < 0.3) return 'cr√≠tico';
            if (media < 0.6) return 'regular';
            if (media < 0.8) return 'bom';
            return 'excelente';
        },
        
        resetar: function() {
            this.estado = {
                alimentacao: 1.0,
                agua: 1.0,
                vinculo: 0.1,
                descanso: 1.0,
                cliques: 0,
                movimentos: 0,
                ultimaAtualizacao: Date.now()
            };
            this.atualizarInterface();
        },
        
        // Fun√ß√£o para salvar o estado atual
        salvarEstado: function() {
            return {
                alimentacao: this.estado.alimentacao,
                agua: this.estado.agua,
                vinculo: this.estado.vinculo,
                descanso: this.estado.descanso,
                cliques: this.estado.cliques,
                movimentos: this.estado.movimentos,
                ultimaAtualizacao: this.estado.ultimaAtualizacao
            };
        },
        
        // Fun√ß√£o para carregar o estado
        carregarEstado: function(estadoSalvo) {
            if (estadoSalvo) {
                this.estado.alimentacao = estadoSalvo.alimentacao || 0.5;
                this.estado.agua = estadoSalvo.agua || 0.5;
                this.estado.vinculo = estadoSalvo.vinculo || 0.1;
                this.estado.descanso = estadoSalvo.descanso || 1.0;
                this.estado.cliques = estadoSalvo.cliques || 0;
                this.estado.movimentos = estadoSalvo.movimentos || 0;
                this.estado.ultimaAtualizacao = estadoSalvo.ultimaAtualizacao || Date.now();
                this.atualizarInterface();
                return true;
            }
            return false;
        }
    };

    // Fun√ß√µes do Jogo
    
    function criarEstruturas() {
        estruturas.length = 0;
        
        for (let i = 0; i < 5; i++) {
            let xPos = barracaConfig.startX + i * (barracaConfig.width + barracaConfig.spacing);
            let yPos = barracaConfig.startY;
            
            if (i === 0) {
                xPos -= 100;
                yPos -= 50;
            }
            
            estruturas.push({
                x: xPos,
                y: yPos,
                width: barracaConfig.width,
                height: barracaConfig.height,
                loaded: false,
                isHovered: false,
                id: i,
                fileira: 1,
                tipo: i === 0 ? 'lideranca' : 'barraco_familiar',
                nome: nomesEstruturas[i]
            });
        }

        const deslocamentoX = barracaConfig.width + barracaConfig.spacing;
        for (let i = 0; i < 5; i++) {
            estruturas.push({
                x: barracaConfig.startX + deslocamentoX + i * (barracaConfig.width + barracaConfig.spacing),
                y: barracaConfig.startY + barracaConfig.height + barracaConfig.verticalSpacing,
                width: barracaConfig.width,
                height: barracaConfig.height,
                loaded: false,
                isHovered: false,
                id: i + 5,
                fileira: 2,
                tipo: i === 4 ? 'barraco_personagem' : 'barraco_familiar',
                nome: nomesEstruturas[i + 5]
            });
        }

        estruturas.push({
            x: 1737,
            y: 421,
            width: 350,
            height: 300,
            loaded: false,
            isHovered: false,
            id: 10,
            fileira: 3,
            tipo: 'acude',
            nome: 'A√ßude'
        });
    }

    function calculateDimensions(imgWidth, imgHeight, maxWidth, maxHeight) {
        let width, height;
        const ratio = imgWidth / imgHeight;
        
        width = maxWidth;
        height = width / ratio;
        
        if (height > maxHeight) {
            height = maxHeight;
            width = height * ratio;
        }
        
        return { width, height };
    }

    function getDirection(dx, dy) {
        if (dx === 0 && dy === 0) return lastDirection;
        
        const angle = Math.atan2(dy, dx) * (180 / Math.PI);
        
        if (angle >= -45 && angle < 45) {
            return 'right';
        } else if (angle >= 45 && angle < 135) {
            return 'down';
        } else if (angle >= -135 && angle < -45) {
            return 'up';
        } else {
            return 'left';
        }
    }

    function isPlayerOnEstrutura() {
        const playerScreenX = player.x - cameraX;
        const playerScreenY = player.y - cameraY;
        
        const playerLeft = playerScreenX - player.width / 2;
        const playerRight = playerScreenX + player.width / 2;
        const playerTop = playerScreenY - player.height / 2;
        const playerBottom = playerScreenY + player.height / 2;
        
        for (let i = 0; i < estruturas.length; i++) {
            const estrutura = estruturas[i];
            if (!estrutura.loaded) continue;
            
            const estruturaScreenX = estrutura.x - cameraX;
            const estruturaScreenY = estrutura.y - cameraY;
            
            const estruturaLeft = estruturaScreenX;
            const estruturaRight = estruturaScreenX + estrutura.width;
            const estruturaTop = estruturaScreenY;
            const estruturaBottom = estruturaScreenY + estrutura.height;
            
            if (!(playerRight < estruturaLeft || 
                  playerLeft > estruturaRight || 
                  playerBottom < estruturaTop || 
                  playerTop > estruturaBottom)) {
                return true;
            }
        }
        
        return false;
    }

    function getEstruturaClicada(x, y) {
        for (let i = 0; i < estruturas.length; i++) {
            const estrutura = estruturas[i];
            if (!estrutura.loaded) continue;
            
            const estruturaScreenX = estrutura.x - cameraX;
            const estruturaScreenY = estrutura.y - cameraY;
            
            if (x >= estruturaScreenX && 
                x <= estruturaScreenX + estrutura.width && 
                y >= estruturaScreenY && 
                y <= estruturaScreenY + estrutura.height) {
                return i;
            }
        }
        return -1;
    }

    function getEmojiClicado(x, y) {
        for (let i = 0; i < emojisFixos.length; i++) {
            const emoji = emojisFixos[i];
            if (!emoji.ativa) continue;
            
            const emojiScreenX = emoji.x - cameraX;
            const emojiScreenY = emoji.y - cameraY;
            
            const distancia = Math.sqrt(
                Math.pow(x - emojiScreenX, 2) + 
                Math.pow(y - emojiScreenY, 2)
            );
            
           
if (distancia < emoji.size / 2.0) {
    return i;
}
        }
        return -1;
    }

    function updateHoverEstruturas(x, y) {
        let hovered = false;
        
        for (let i = 0; i < estruturas.length; i++) {
            const estrutura = estruturas[i];
            if (!estrutura.loaded) continue;
            
            const estruturaScreenX = estrutura.x - cameraX;
            const estruturaScreenY = estrutura.y - cameraY;
            
            estrutura.isHovered = (x >= estruturaScreenX && 
                                  x <= estruturaScreenX + estrutura.width && 
                                  y >= estruturaScreenY && 
                                  y <= estruturaScreenY + estrutura.height);
            
            if (estrutura.isHovered) {
                hovered = true;
            }
        }
        
        emojisFixos.forEach(emoji => {
            if (!emoji.ativa) return;
            
            const emojiScreenX = emoji.x - cameraX;
            const emojiScreenY = emoji.y - cameraY;
            
            const distancia = Math.sqrt(
                Math.pow(x - emojiScreenX, 2) + 
                Math.pow(y - emojiScreenY, 2)
            );
            
            emoji.isHovered = distancia < emoji.size / 2;
            
            if (emoji.isHovered) {
                canvas.style.cursor = 'pointer';
            }
        });
        
        canvas.style.cursor = hovered ? 'pointer' : 'default';
    }

    // Transformar planta em dinheiro - tamb√©m adiciona 6 alimentos ao invent√°rio
    function transformarEmDinheiro(planta) {
        if (planta.tipo !== 'planta') return;
        
        // Adicionar 6 alimentos do tipo usado na cria√ß√£o da planta√ß√£o ao invent√°rio
        if (planta.alimentoBase) {
            for (let i = 0; i < 6; i++) {
                // Encontrar slot vazio
                const slotVazio = inventario.findIndex(item => item === null);
                
                if (slotVazio !== -1) {
                    inventario[slotVazio] = {
                        emoji: planta.alimentoBase.emoji,
                        tipo: planta.alimentoBase.tipo,
                        nome: planta.alimentoBase.nome,
                        quantidade: 1
                    };
                } else {
                    // Se n√£o h√° slot vazio, adicionar ao primeiro item do mesmo tipo
                    const itemExistente = inventario.findIndex(item => 
                        item && item.nome === planta.alimentoBase.nome
                    );
                    
                    if (itemExistente !== -1) {
                        inventario[itemExistente].quantidade += 1;
                    } else {
                        // Se n√£o encontrou e n√£o h√° slots, n√£o pode adicionar
                        mostrarMensagemRapida('Invent√°rio cheio! N√£o foi poss√≠vel adicionar os alimentos.');
                        break;
                    }
                }
            }
            
            mostrarMensagemRapida(`üåæ Colheita completa! Recebeu R$ 10 + 6x ${planta.alimentoBase.nome}!`);
            atualizarInventario();
        }
        
        planta.tipo = 'dinheiro';
        planta.emoji = 'üí∞';
        planta.color = '#FFD700';
        planta.size = 45;
        
        plantasTransformadas++;
        nivelJogador = plantasTransformadas + 1;
        
        atualizarIndicadores();
        tocarSom('somDinheiro');
    }

    function atualizarIndicadores() {
        nivelNumero.textContent = nivelJogador;
        dinheiroNumero.textContent = dinheiroJogador;
        casaNumero.textContent = nivelCasaPersonagem;
        
        nivelIndicador.style.transform = 'scale(1.1)';
        dinheiroIndicador.style.transform = 'scale(1.1)';
        casaIndicador.style.transform = 'scale(1.1)';
        
        setTimeout(() => {
            nivelIndicador.style.transform = 'scale(1)';
            dinheiroIndicador.style.transform = 'scale(1)';
            casaIndicador.style.transform = 'scale(1)';
        }, 200);
    }

function configurarMenuPlanta(planta) {
    plantaSelecionada = planta.id;
    
    if (planta.tipo === 'planta') {
        tituloPlanta.textContent = `Planta ${planta.emoji}`;
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        // Calcular porcentagem de desenvolvimento baseado no n√≠vel
        const incremento = Math.min(25, 5 + Math.floor(nivelJogador / 2));
        btnDesenvolver.textContent = `üå± Desenvolver (+${incremento}%)`;
        
        btnDesenvolver.style.display = 'block';
        btnDesenvolver.className = 'opcao-planta btn-desenvolver';
        
        btnAcao.textContent = 'üóëÔ∏è Remover Planta';
        btnAcao.className = 'opcao-planta btn-remover';
        
        if (planta.porcentagem >= 100) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
        } else if (planta.porcentagem >= 70) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #32CD32, #228B22)';
        } else if (planta.porcentagem >= 40) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #90EE90, #32CD32)';
        } else {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #90EE90, #228B22)';
        }
    } else if (planta.tipo === 'dinheiro') {
        tituloPlanta.textContent = `Ganho Financeiro ${planta.emoji}`;
        porcentagemPlanta.textContent = '100';
        barraProgressoPlanta.style.width = '100%';
        barraProgressoPlanta.textContent = '100%';
        barraProgressoPlanta.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
        
        btnDesenvolver.style.display = 'none';
        
        btnAcao.textContent = 'üí∞ Receber';
        btnAcao.className = 'opcao-planta btn-receber';
    } else if (planta.tipo === 'arvore') {
        tituloPlanta.textContent = `√Årvore ${planta.emoji}`;
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        // Se a √°rvore ainda n√£o foi derrubada
        if (planta.porcentagem > 0) {
            btnDesenvolver.textContent = 'ü™ì Derrubar';
            btnDesenvolver.className = 'opcao-planta btn-desenvolver';
            btnDesenvolver.style.display = 'block';
            
            btnAcao.textContent = 'üçé Coletar';
            btnAcao.className = 'opcao-planta btn-receber';
            btnAcao.style.display = 'block';
        } else {
            // √Årvore derrubada - virou dinheiro
            tituloPlanta.textContent = `Ganho Financeiro ${planta.emoji}`;
            porcentagemPlanta.textContent = '100';
            barraProgressoPlanta.style.width = '100%';
            barraProgressoPlanta.textContent = '100%';
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
            
            btnDesenvolver.style.display = 'none';
            
            btnAcao.textContent = 'üí∞ Receber';
            btnAcao.className = 'opcao-planta btn-receber';
        }
    } else if (planta.tipo === 'galinha') {
        tituloPlanta.textContent = `Galinha ${planta.emoji}`;
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        btnDesenvolver.textContent = 'üåΩ Alimentar';
        btnDesenvolver.className = 'opcao-planta btn-desenvolver';
        btnDesenvolver.style.display = 'block';
        
        btnAcao.textContent = 'üçó Realizar Abate';
        btnAcao.className = 'opcao-planta btn-receber';
        btnAcao.style.display = 'block';
    } else if (planta.tipo === 'broto') {
        tituloPlanta.textContent = `Broto ${planta.emoji}`;
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        // CORRE√á√ÉO: Mostrar "üå± Desenvolver" para o broto, n√£o "ü™ì Derrubar"
        const incremento = Math.min(25, 5 + Math.floor(nivelJogador / 2));
        btnDesenvolver.textContent = `üå± Desenvolver (+${incremento}%)`;
        btnDesenvolver.className = 'opcao-planta btn-desenvolver';
        btnDesenvolver.style.display = 'block';
        
        btnAcao.textContent = 'üóëÔ∏è Remover Broto';
        btnAcao.className = 'opcao-planta btn-remover';
        btnAcao.style.display = 'block';
        
        // CORRE√á√ÉO: Adicionar l√≥gica de cores da barra de progresso para o broto
        if (planta.porcentagem >= 100) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
        } else if (planta.porcentagem >= 70) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #32CD32, #228B22)';
        } else if (planta.porcentagem >= 40) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #90EE90, #32CD32)';
        } else {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #90EE90, #228B22)';
        }
    } else if (planta.tipo === 'pintinho') {
        tituloPlanta.textContent = `Pintinho ${planta.emoji}`;
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        btnDesenvolver.textContent = 'üåΩ Desenvolver';
        btnDesenvolver.className = 'opcao-planta btn-desenvolver';
        btnDesenvolver.style.display = 'block';
        
        btnAcao.textContent = 'üí∞ Coletar';
        btnAcao.className = 'opcao-planta btn-receber';
        btnAcao.style.display = 'block';
    }
    return true;
}

    function configurarMenu(estrutura) {
        tituloMenu.textContent = estrutura.nome;
        
        const container = menuBarraca.querySelector('.opcoes-container');
        if (container) {
            container.innerHTML = '';
        } else {
            const novoContainer = document.createElement('div');
            novoContainer.className = 'opcoes-container';
            menuBarraca.appendChild(novoContainer);
        }
        
        const opcoes = [];
        
        if (estrutura.tipo === 'lideranca') {
            // Bot√£o "Convocar L√≠deres" (antigo Conversar)
            opcoes.push({
                texto: 'üì¢ Convocar L√≠deres',
                onClick: () => {
                    conversarComLiderancas(estrutura);
                    menuBarraca.style.display = 'none';
                }
            });
            
// Bot√£o "INCRA" - AGORA MOSTRA CARROSSEL DE CR√âDITOS
opcoes.push({
    texto: 'üí† INCRA - Solicitar Cr√©dito',
    onClick: () => {
        mostrarCarrosselCredito();
        menuBarraca.style.display = 'none';
        tocarSom('somClique');
    }
});
            
            // Bot√£o "Sair do Assentamento"
            opcoes.push({
                texto: '‚ùå Sair do Assentamento',
                onClick: () => {
                    abrirModalSairAssentamento();
                    menuBarraca.style.display = 'none';
                }
            });
        }
        
        if (estrutura.tipo === 'acude') {
            opcoes.push({
                texto: 'üíß Coletar √°gua',
                onClick: () => {
                    coletarAgua();
                    menuBarraca.style.display = 'none';
                }
            });
            
            // Bot√£o Pescar
            opcoes.push({
                texto: 'üé£ Pescar',
                onClick: () => {
                    pescar();
                    menuBarraca.style.display = 'none';
                }
            });
        }
        
        if (estrutura.id === 9) { // Barraco do personagem
            // Ordem: Invent√°rio, Comer, Dormir, Reformar
            opcoes.push({
                texto: 'üéí Invent√°rio',
                onClick: () => {
                    menuBarraca.style.display = 'none';
                    abrirInventario();
                }
            });
            
            opcoes.push({
                texto: 'üç≤ Comer',
                onClick: () => {
                    menuBarraca.style.display = 'none';
                    abrirModalComer();
                }
            });
            
            opcoes.push({
                texto: 'üí§ Dormir',
                onClick: () => {
                    menuBarraca.style.display = 'none';
                    dormir();
                }
            });
            
            opcoes.push({
                texto: 'üè† Reformar Casa',
                onClick: () => {
                    menuBarraca.style.display = 'none';
                    abrirModalReformar();
                }
            });
        } else if (estrutura.tipo.includes('barraco') && estrutura.id !== 0) {
            // Para as outras barracas (B2 a B9) - apenas Conversar
            opcoes.push({
                texto: 'üí¨ Conversar',
                onClick: () => {
                    conversarComVizinho(estrutura);
                    menuBarraca.style.display = 'none';
                }
            });
        }
        
        const opcoesContainer = menuBarraca.querySelector('.opcoes-container');
        opcoes.forEach(opcao => {
            const botao = document.createElement('button');
            botao.className = 'opcao-menu';
            botao.textContent = opcao.texto;
            botao.onclick = opcao.onClick;
            opcoesContainer.appendChild(botao);
        });
    }

    // FUN√á√ÉO: Abrir modal de sair do assentamento
    function abrirModalSairAssentamento() {
        const conteudo = document.getElementById('conteudoSairAssentamento');
        conteudo.innerHTML = `
            <p>Escolha uma op√ß√£o para sair do assentamento:</p>
            <button class="opcao-menu" onclick="mostrarOpcaoSair(1)">Vender o lote</button>
            <button class="opcao-menu" onclick="mostrarOpcaoSair(2)">Arrendar a terra</button>
            <button class="opcao-menu" onclick="mostrarOpcaoSair(3)">Deixar sem ningu√©m</button>
            <button class="opcao-menu" onclick="mostrarOpcaoSair(4)">Comunicar ao INCRA</button>
        `;
        modalSairAssentamento.style.display = 'block';
        tocarSom('somClique');
    }

    // FUN√á√ÉO: Mostrar op√ß√£o de sair espec√≠fica
    function mostrarOpcaoSair(opcao) {
        const conteudo = document.getElementById('conteudoSairAssentamento');
        let mensagem = '';
        let titulo = '';
        
        switch(opcao) {
            case 1: // Vender o lote
                titulo = 'Vender o lote';
                mensagem = 'Voc√™ deveria ter procurado a superintend√™ncia do INCRA para fazer a Desist√™ncia Formal, mas preferiu vender ilegalmente. O INCRA descobriu e o comprador foi despejado e perdeu tudo. Voc√™ foi processado por negociar terras da Uni√£o e seu nome entrou para a "lista suja", impedindo voc√™ de conseguir qualquer benef√≠cio do governo ou novos lotes para sempre.';
                break;
            case 2: // Arrendar a terra
                titulo = 'Arrendar a terra';
                mensagem = 'A terra do assentamento √© para o trabalho da pr√≥pria fam√≠lia. Se voc√™ n√£o pode mais trabalhar nela, o correto √© devolv√™-la ao INCRA para que outra fam√≠lia de agricultores tenha a chance que voc√™ teve. Como voc√™ arrendou e isso √© proibido por lei, o INCRA descobriu e voc√™ perdeu o lote, sem direito √† indeniza√ß√£o.';
                break;
            case 3: // Deixar sem ningu√©m
                titulo = 'Deixar sem ningu√©m';
                mensagem = 'Voc√™ trancou a porta e foi tentar a vida na cidade, deixando o seu lote sem fun√ß√£o social. Foi ent√£o considerado abandonado pelo INCRA e voc√™ perdeu o direito √† indeniza√ß√£o pelas benfeitorias porque n√£o oficializou sua sa√≠da.';
                break;
            case 4: // Comunicar ao INCRA
                titulo = 'Comunicar ao INCRA';
                mensagem = 'Parab√©ns! Esse √© o √∫nico caminho que garante que voc√™ receba o valor do que investiu na constru√ß√£o do lote de forma legal. O INCRA avaliou tudo o que voc√™ construiu e te pagou uma Indeniza√ß√£o pelas Benfeitorias. Seu nome continua limpo, e voc√™ entregou a chave para uma nova fam√≠lia que estava na lista de espera, garantindo que a terra continue produzindo.';
                break;
        }
        
        conteudo.innerHTML = `
            <h4 style="color: #5C3317; margin-bottom: 15px;">${titulo}</h4>
            <p style="line-height: 1.6; margin-bottom: 20px;">${mensagem}</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primario" onclick="confirmarSaida(${opcao})" style="flex: 1;">Confirmar</button>
                <button class="btn-secundario" onclick="abrirModalSairAssentamento()" style="flex: 1;">Retornar</button>
            </div>
        `;
        tocarSom('somClique');
    }

    // FUN√á√ÉO: Confirmar sa√≠da (game over)
    function confirmarSaida(opcao) {
        let motivo = '';
        let fimEspecial = false;
        
        switch(opcao) {
            case 1:
                motivo = 'Vendeu o lote ilegalmente. Foi processado e entrou para a "lista suja" do governo.';
                break;
            case 2:
                motivo = 'Arrendou a terra, o que √© proibido por lei. Perdeu o lote sem indeniza√ß√£o.';
                break;
            case 3:
                motivo = 'Abandonou o lote sem fun√ß√£o social. Perdeu o direito √† indeniza√ß√£o pelas benfeitorias.';
                break;
            case 4:
                fimEspecial = true;
                break;
        }
        
        modalSairAssentamento.style.display = 'none';
        
        if (fimEspecial) {
            // Mostrar tela de fim especial
            mensagemFimEspecial.textContent = formatarAssentamento('Comunicou ao INCRA e recebeu a Indeniza√ß√£o pelas Benfeitorias. Seu nome continua limpo, e voc√™ entregou a chave para uma nova fam√≠lia que estava na lista de espera, garantindo que a terra continue produzindo.');
            telaFimEspecial.style.display = 'flex';
            tocarSom('somSucesso');
        } else {
            SistemaIndicadores.gameOver(motivo);
        }
    }

    // FUN√á√ÉO: Restaurar imagem dos l√≠deres
function restaurarImagemLideranca() {
    if (liderancaImagemAlterada) {
        // Determinar o n√≠vel correto para a lideran√ßa
        let nivelLideranca = nivelCasaPersonagem;
        if (nivelLideranca > 4) nivelLideranca = 4;
        
        // Restaurar para a imagem normal correspondente ao n√≠vel
        if (imagensLiderancaPorNivel[nivelLideranca]) {
            images.lideranca.src = imagensLiderancaPorNivel[nivelLideranca].normal;
        } else {
            // Fallback para a imagem original
            images.lideranca.src = imageUrls.lideranca;
        }
        liderancaImagemAlterada = false;
    }
}

// Vari√°veis para o carrossel de cr√©dito
let carrosselCreditoAtual = 0;
let carrosselCreditos = [];

// Fun√ß√£o para inicializar os dados do carrossel
function inicializarCarrosselCredito() {
    carrosselCreditos = [
        {
            titulo: "Habitacional (At√© R$ 97.500,00)",
            descricao: "Cr√©dito destinado √† constru√ß√£o da moradia definitiva de fam√≠lias cadastradas no Programa Nacional de Reforma Agr√°ria - PNRA."
        },
        {
            titulo: "Reforma Habitacional (At√© R$ 50.000,00)",
            descricao: "Recurso para a melhoria, amplia√ß√£o ou recupera√ß√£o de habita√ß√µes j√° existentes."
        },
        {
            titulo: "Fomento (R$ 16.000,00)",
            descricao: "Recurso para viabilizar projetos produtivos que garantam a seguran√ßa alimentar e a gera√ß√£o de renda, geralmente liberado em duas opera√ß√µes de R$ 8 mil."
        },
        {
            titulo: "Fomento Jovem (R$ 8.000,00)",
            descricao: "Cr√©dito voltado especificamente para jovens entre 16 e 29 anos, incentivando o empreendedorismo e a sucess√£o rural."
        },
        {
            titulo: "Fomento Mulher (R$ 8.000,00)",
            descricao: "Apoio financeiro exclusivo para as mulheres titulares dos lotes investirem em seus pr√≥prios projetos de produ√ß√£o."
        },
        {
            titulo: "Semi√°rido (R$ 8.000,00)",
            descricao: "Focado em garantir a seguran√ßa h√≠drica, permitindo investimentos em solu√ß√µes para capta√ß√£o e armazenamento de √°gua."
        },
        {
            titulo: "Florestal (R$ 8.000,00)",
            descricao: "Investimento direcionado ao manejo de florestas, sistemas agroflorestais ou explora√ß√£o de reservas legais de forma sustent√°vel."
        },
        {
            titulo: "Recupera√ß√£o Ambiental (R$ 8.000,00)",
            descricao: "Verba para financiar a√ß√µes de preserva√ß√£o, conserva√ß√£o e recupera√ß√£o de √°reas degradadas dentro do lote."
        },
        {
            titulo: "Cacau (R$ 8.000,00)",
            descricao: "Cr√©dito espec√≠fico para a implanta√ß√£o, manejo ou recupera√ß√£o de lavouras de cacau, integradas a sistemas produtivos sustent√°veis."
        },
        {
            titulo: "Apoio Inicial (R$ 8.000,00)",
            descricao: "Destinado √† aquisi√ß√£o de itens de primeira necessidade, ferramentas manuais e equipamentos b√°sicos para a instala√ß√£o inicial da fam√≠lia."
        }
    ];
}

// Fun√ß√£o para mostrar o carrossel de cr√©dito
function mostrarCarrosselCredito() {
    // Verificar se j√° recebeu o cr√©dito
    if (localStorage.getItem('incra_credito_recebido') === 'true') {
        mostrarMensagemRapida('‚ö†Ô∏è Voc√™ j√° recebeu o Cr√©dito de Apoio Inicial!');
        return;
    }
    
    // Inicializar carrossel se necess√°rio
    if (carrosselCreditos.length === 0) {
        inicializarCarrosselCredito();
    }
    
    carrosselCreditoAtual = 0;
    atualizarCarrosselCredito();
    modalCarrosselCredito.style.display = 'block';
    tocarSom('somClique');
}

// Fun√ß√£o para atualizar o conte√∫do do carrossel
function atualizarCarrosselCredito() {
    const conteudo = document.getElementById('conteudoCarrosselCredito');
    const btnAnterior = document.getElementById('btnAnteriorCredito');
    const btnProximo = document.getElementById('btnProximoCredito');
    const btnReceber = document.getElementById('btnReceberCredito');
    
    const item = carrosselCreditos[carrosselCreditoAtual];
    
    conteudo.innerHTML = `
        <div class="conteudo-credito-item">
            <div class="conteudo-credito-titulo">${item.titulo}</div>
            <div class="conteudo-credito-descricao">${item.descricao}</div>
        </div>
        <div class="indicador-carrossel">${carrosselCreditoAtual + 1} / ${carrosselCreditos.length}</div>
    `;
    
    // Atualizar visibilidade dos bot√µes
    btnAnterior.style.display = carrosselCreditoAtual === 0 ? 'none' : 'inline-block';
    
    if (carrosselCreditoAtual === carrosselCreditos.length - 1) {
        btnProximo.style.display = 'none';
        btnReceber.style.display = 'inline-block';
    } else {
        btnProximo.style.display = 'inline-block';
        btnReceber.style.display = 'none';
    }
}

// Fun√ß√£o para navegar no carrossel
function navegarCarrosselCredito(direcao) {
    carrosselCreditoAtual += direcao;
    
    // Limitar entre 0 e total-1
    if (carrosselCreditoAtual < 0) carrosselCreditoAtual = 0;
    if (carrosselCreditoAtual >= carrosselCreditos.length) carrosselCreditoAtual = carrosselCreditos.length - 1;
    
    atualizarCarrosselCredito();
    tocarSom('somClique');
}

// Fun√ß√£o para receber o cr√©dito de apoio
function receberCreditoApoio() {
    fecharModal('modalCarrosselCredito');
    
    // Dar cr√©dito INCRA (chama a fun√ß√£o existente)
    darCreditoINCRA();
}

    // FUN√á√ÉO: Conversar com as lideran√ßas com di√°logo control√°vel
function conversarComLiderancas(estrutura) {
    // Verificar se j√° houve primeiro contato
    const primeiroContato = localStorage.getItem('lideranca_contato_inicial') !== 'true';
    
    // DEBUG: Vamos ver qual n√≠vel est√° sendo usado
    console.log('DEBUG: nivelCasaPersonagem =', nivelCasaPersonagem);
    console.log('DEBUG: imagensLiderancaPorNivel[nivelCasaPersonagem] =', imagensLiderancaPorNivel[nivelCasaPersonagem]);
    
    // Determinar o n√≠vel correto para a lideran√ßa
    let nivelLideranca = nivelCasaPersonagem;
    if (nivelLideranca > 3) nivelLideranca = 3;
    
    console.log('DEBUG: nivelLideranca usado =', nivelLideranca);
    console.log('DEBUG: Imagem normal =', imagensLiderancaPorNivel[nivelLideranca]?.normal);
    console.log('DEBUG: Imagem conversa =', imagensLiderancaPorNivel[nivelLideranca]?.conversa);
    
    // Verificar se temos imagem para este n√≠vel
    if (!imagensLiderancaPorNivel[nivelLideranca]) {
        console.error('ERRO: N√£o encontrou imagem para n√≠vel', nivelLideranca);
        // Usar n√≠vel 0 como fallback
        nivelLideranca = 0;
    }
    
    // Trocar para a nova imagem baseada no n√≠vel atual
    images.lideranca.src = imagensLiderancaPorNivel[nivelLideranca].conversa;
    
    liderancaImagemAlterada = true;
    
    // Preparar a conversa
    conversaAtual = [];
    estruturaConversaAtual = estrutura.id;
    
    if (primeiroContato) {
        conversaAtual = [
            "Ol√°, somos as lideran√ßas do assentamento. Fomos sorteados e recebemos lotes do INCRA, tendo como miss√£o dar uma fun√ß√£o social para o que um dia foi uma fazenda improdutiva.",
            "√â sua miss√£o trabalhar a terra e tirar o melhor dela. Ent√£o, o INCRA disponibilizou para voc√™ um Cr√©dito de Apoio Inicial. Basta entrar novamente no nosso barraco e clicar em 'INCRA'.",
            "Depois de receber as ferramentas e o dinheiro, v√° at√© o final do assentamento e construa seu barraco de lona. Por enquanto, ser√° um abrigo simples, mas logo em breve, com o dinherio das suas vendas, voc√™ poder√° reform√°-la! Boa sorte na lida!"
        ];
    } else {
        conversaAtual = [
            "Ol√° novamente! Temos peixes no a√ßude, sabia? Se precisar coletar mais √°gua, use o Recipiente. Se precisar de iscas para pescar, basta procurar nas √°rvores.",
            "Como anda sua galinha? Voc√™ pode comer os ovos dela ou us√°-los para aumentar sua cria√ß√£o. N√£o se esque√ßa de plantar bastante milho e sempre ter o que dar de alimento a elas!",
            "Quanto mais plantar, mais ter√° o que comer e dinheiro para reformar sua casa! Boa sorte!"
        ];
    }
    
    paginaConversaAtual = 0;
    tituloConversa.textContent = formatarAssentamento('Lideran√ßas do Assentamentoüë•');
    mostrarPaginaConversa();
    modalConversa.style.display = 'block';
    
    // Registrar primeiro contato
    if (primeiroContato) {
        localStorage.setItem('lideranca_contato_inicial', 'true');
    }
    
    SistemaIndicadores.aumentarVinculo(primeiroContato ? 3 : 1);
    tocarSom(primeiroContato ? 'somSucesso' : 'somClique');
}
    // Objeto de conselhos dos vizinhos - textos atualizados
    const conselhosVizinhos = {
        1: "Ol√°, trabalhe duro na sua terra! A gente tem que morar e produzir aqui de verdade. Se o INCRA vier e teu lote for considerado improdutivo, eles pegam de volta. O t√≠tulo √© o pr√™mio final para quem tem paci√™ncia e trabalha na terra!",
        2: "Ei, voc√™ j√° pediu Cr√©dito Instala√ß√£o para reformar teu barraco? Mais √≥, escuta o que eu digo: esse dinheiro √© pra semente, ferramenta e pro gado. N√£o v√° gastar com coisa de luxo ou carro velho, sen√£o a d√≠vida vira uma bola de neve e o lote n√£o produz!",
        3: "Sabe aquele feij√£o, arroz e salada que a gente come e planta? O INCRA √© quem nos ajuda e, desde modo, ajuda tamb√©m a colocar comida no prato dos brasileiros. Mais de 1 milh√£o de fam√≠lias como as nossas moram em terras organizadas pelo Incra. N√≥s, os pequenos produtores, somos os respons√°veis por mais de 70% da comida fresca que chega √†s feiras e supermercados.",
        4: "Ei, segura esse machado! No assentamento, a gente n√£o pode sair derrubando o mato de qualquer jeito, n√£o, que isso √© crime ambiental dos brabos. A terra √© generosa, mas ela tem regras: as beiras de rio e o topo dos morros s√£o √Åreas de Preserva√ß√£o (APP) e a gente n√£o encosta nelas pro olho d'√°gua n√£o secar. Al√©m disso, tem a Reserva Legal, que √© o peda√ßo de mata que garante o equil√≠brio de tudo aqui. Preservar a natureza faz parte do nosso acordo com o INCRA pra manter o lote; se o √≥rg√£o v√™ que houve desmate ilegal, a gente perde o direito ao ch√£o e ainda ganha uma multa que n√£o acaba mais. Cuide da mata que ela cuida da sua colheita!",
        5: "Queria mesmo falar contigo... Sabia que me formei em Agronomia gra√ßas ao PRONERA? Esse √© um programa que garante que a gente estude um tempo na universidade, mas continue trabalhando no lote aplicando tudo na pr√°tica. Chamam isso de Pedagogia da Altern√¢ncia.",
        6: "Sabia que sou vi√∫vo? Como sou eu que vou ficar aqui no lote segurando o cabo da enxada e cuidando da cria√ß√£o, tenho que ir at√© o INCRA e passar a posse pra meu nome. Se a gente n√£o ajeita essa situa√ß√£o logo, as coisas travam: n√£o sai um cr√©dito no banco, a associa√ß√£o fica capenga e at√© a aposentadoria periga n√£o vir.",
        7: "√ä, deixa eu te avisar: d√™ um pulo na cidade e veja como t√° o seu Cad√önico, porque se o cadastro tiver 'torto', n√£o vai conseguir pegar cr√©dito com INCRA n√£o, sabia?",
        8: "Olha, deixa eu te falar uma coisa: o T√≠tulo Definitivo da terra n√£o chega de um dia pro outro, n√£o! Primeiro, o INCRA precisa ver voc√™ trabalhando no assentamento por um tempo, seguindo todas as regras. Depois desse tempo, a√≠ sim a gente vai ao cart√≥rio e vira dono de papel passado. Entendeu?"
    };

    // NOVA FUN√á√ÉO: Conversar com vizinho
    function conversarComVizinho(estrutura) {
        const vizinhoIndex = estrutura.id - 1; // B2 = id 1, B3 = id 2, etc.
        const conselho = conselhosVizinhos[vizinhoIndex] || "Ol√°, sempre que precisar de bons conselhos, basta nos chamar para conversar, seus vizinhos!";
        
        conversaAtual = [formatarAssentamento(conselho)];
        paginaConversaAtual = 0;
        estruturaConversaAtual = estrutura.id;
        tituloConversa.textContent = `Vizinhos ${estrutura.nome.split(' ')[2]}`;
        
        mostrarPaginaConversa();
        modalConversa.style.display = 'block';
        
        SistemaIndicadores.aumentarVinculo(50);
        tocarSom('somClique');
    }

    // NOVA FUN√á√ÉO: Mostrar p√°gina da conversa
    function mostrarPaginaConversa() {
        if (paginaConversaAtual < 0 || paginaConversaAtual >= conversaAtual.length) {
            return;
        }
        
        conteudoConversa.innerHTML = `<p>${conversaAtual[paginaConversaAtual]}</p>`;
        
        // Atualizar bot√µes de navega√ß√£o
        btnAnterior.disabled = paginaConversaAtual === 0;
        btnProximo.disabled = paginaConversaAtual === conversaAtual.length - 1;
    }

    // NOVA FUN√á√ÉO: Navegar na conversa
    function navegarConversa(direcao) {
        paginaConversaAtual += direcao;
        if (paginaConversaAtual < 0) paginaConversaAtual = 0;
        if (paginaConversaAtual >= conversaAtual.length) paginaConversaAtual = conversaAtual.length - 1;
        
        mostrarPaginaConversa();
        tocarSom('somClique');
    }

    // NOVA FUN√á√ÉO: Carregar alimentos no modal
    function carregarAlimentosNoModal() {
        listaAlimentos.innerHTML = '';
        
        let temAlimento = false;
        
        inventario.forEach((item, index) => {
            if (item && item.tipo === 'alimento') {
                temAlimento = true;
                const div = document.createElement('div');
                div.className = 'item-alimento';
                div.innerHTML = `
                    <div class="alimento-info">
                        <div class="alimento-emoji">${item.emoji}</div>
                        <div class="alimento-detalhes">
                            <div class="alimento-nome">${item.nome}</div>
                            <div class="alimento-quantidade">Quantidade: ${item.quantidade}</div>
                        </div>
                    </div>
                    <button class="btn-comer" onclick="consumirAlimento(${index}, 'modal')">Comer</button>
                `;
                listaAlimentos.appendChild(div);
            }
        });
        
        if (!temAlimento) {
            listaAlimentos.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">N√£o h√° alimentos no invent√°rio. Plante e colha alimentos para comer!</p>';
        }
    }

    // FUN√á√ÉO: Abrir modal de comer
    function abrirModalComer() {
        carregarAlimentosNoModal();
        modalComer.style.display = 'block';
        tocarSom('somClique');
    }

    // ATUALIZADA: Fun√ß√£o consumir alimento (do modal de comer) 
    function consumirAlimento(index, origem = 'modal') {
        const item = inventario[index];
        if (!item || item.tipo !== 'alimento') {
            mostrarMensagemRapida('Item inv√°lido para consumo!');
            return;
        }
        
        if (item.quantidade <= 0) {
            inventario[index] = null;
            mostrarMensagemRapida('Este alimento acabou!');
            atualizarInventario();
            if (origem === 'modal') {
                abrirModalComer();
            }
            return;
        }
        
        // Aumentar alimenta√ß√£o com exce√ß√µes especiais
        let aumento = 5 + (Math.random() * 10); // 5 a 15 unidades de alimentos

        // CASOS ESPECIAIS:
        if (item.nome === "Ovo") {
            aumento = 50; // ‚≠ê 50% (50 unidades √ó 0,01 = 50%)
        } else if (item.nome === "Frango assado") {
            aumento = 100; // ‚≠ê 100% (100 unidades √ó 0,01 = 100%)
        } else if (item.nome === "Peixe") {
            aumento = 80; // ‚≠ê 80% (80 unidades √ó 0,01 = 80%)
        }
        
        SistemaIndicadores.aumentarAlimentacao(aumento);
        
        // Reduzir apenas UMA unidade
        item.quantidade -= 1;
        
        if (item.quantidade <= 0) {
            inventario[index] = null;
        }
        
        // Mostrar mensagem
        const aumentoPercentual = Math.round(aumento * 100);
        mostrarMensagemRapida(`üçΩÔ∏è Comeu 1x ${item.nome}! Indicador de Alimenta√ß√£o aumentado!`);
        
        // Atualizar invent√°rio
        atualizarInventario();
        
        // Atualizar interface conforme origem
        if (origem === 'modal') {
            carregarAlimentosNoModal(); // Recarrega a lista atualizada
        } else if (origem === 'inventario') {
            if (inventario[index]) {
                selecionarItemInventario(index);
            } else {
                slotSelecionadoContainer.style.display = 'none';
                itemSelecionadoIndex = -1;
                // Desabilitar bot√µes
                btnConsumir.disabled = true;
                btnUsar.disabled = true;
                btnVender.disabled = true;
            }
        }
        
        tocarSom('somClique');
    }

function dormir() {
    telaDormir.style.display = 'flex';
    
    // Esconder bot√£o acordar inicialmente
    const btnAcordar = document.getElementById('btnAcordar');
    if (btnAcordar) {
        btnAcordar.style.display = 'none';
    }
    
    // Iniciar barra de progresso
    let progresso = 0;
    const duracao = 5000; // 5 segundos
    const intervalo = 100;
    
    const timer = setInterval(() => {
        progresso += (intervalo / duracao) * 100;
        progressoDormir.style.width = progresso + '%';
        progressoDormir.textContent = Math.round(progresso) + '%';
        
        if (progresso >= 100) {
            clearInterval(timer);
            progressoDormir.textContent = '100%';
            
            // Mostrar bot√£o acordar
            if (btnAcordar) {
                btnAcordar.style.display = 'block';
            }
        }
    }, intervalo);
    
    tocarSom('somDormir');
}

function acordar() {
    // Recuperar descanso
    SistemaIndicadores.aumentarDescanso(50);
    
    // Fechar tela de dormir
    telaDormir.style.display = 'none';
    
    // Salvar jogo
    salvarJogo();
    
    mostrarMensagemRapida('üí§ Sono recuperado! Indicador de Descanso aumentado em 50%.');
    tocarSom('somClique');
}

    function carregarJogo() {
        const saveDataString = localStorage.getItem('assentamentoRural_save');
        if (!saveDataString) {
            console.log('Nenhum jogo salvo encontrado.');
            return false;
        }
        
        try {
            const data = JSON.parse(saveDataString);
            console.log('Dados carregados do localStorage:', data);
            
            // Carregar dados b√°sicos
            player.x = data.player?.x || canvasW / 2;
            player.y = data.player?.y || canvasH / 2;
            player.targetX = data.player?.targetX || player.x;
            player.targetY = data.player?.targetY || player.y;
            
            cameraX = data.camera?.x || 0;
            cameraY = data.camera?.y || 0;
            
            nivelJogador = data.nivelJogador || 1;
            dinheiroJogador = data.dinheiroJogador || 0;
            plantasTransformadas = data.plantasTransformadas || 0;
            nivelCasaPersonagem = data.nivelCasaPersonagem || 1;
            progressoReforma = data.progressoReforma || 0;
            inventario = data.inventario || Array(12).fill(null);
            
            // Carregar personagem atual
            personagemAtual = data.personagemAtual || 'pai';
            
            // Atualizar seletores de personagem
            document.querySelectorAll('.emoji-personagem').forEach(sel => {
                sel.classList.remove('selecionado');
                if (sel.dataset.personagem === personagemAtual) {
                    sel.classList.add('selecionado');
                }
            });
            
            // Carregar plantas e elementos
            if (data.emojisFixos && Array.isArray(data.emojisFixos)) {
                // Limpar emojis existentes
                emojisFixos = [];
                data.emojisFixos.forEach(plantaData => {
                    const novaPlanta = {
                        emoji: plantaData.tipo === 'dinheiro' ? 'üí∞' : 
                              plantaData.tipo === 'arvore' ? 'üå≥' :
                              plantaData.tipo === 'galinha' ? 'üêì' :
                              plantaData.tipo === 'pintinho' ? 'üê•' : 'üå±',
                        x: plantaData.x || 1500,
                        y: plantaData.y || 850,
                        size: plantaData.tipo === 'dinheiro' ? 45 : 
                             plantaData.tipo === 'arvore' ? 120 :
                             plantaData.tipo === 'galinha' ? 40 :
                             plantaData.tipo === 'pintinho' ? 20 : 40,
                        color: plantaData.tipo === 'dinheiro' ? '#FFD700' : 
                              plantaData.tipo === 'arvore' ? '#228B22' :
                              plantaData.tipo === 'galinha' ? '#FFD700' :
                              plantaData.tipo === 'pintinho' ? '#FFD700' : '#228B22',
                        isHovered: false,
                        porcentagem: plantaData.porcentagem || 10,
                        ativa: plantaData.ativa !== undefined ? plantaData.ativa : true,
                        id: plantaData.id || 0,
                        tipo: plantaData.tipo || 'planta',
                        alimentoBase: plantaData.alimentoBase || null,
                        tempoUltimaColeta: plantaData.tempoUltimaColeta || 0,
                        tempoUltimaPostura: plantaData.tempoUltimaPostura || 0,
                        posicoesTriangulo: plantaData.posicoesTriangulo || null,
                        indicePosicao: plantaData.indicePosicao || 0
                    };
                    emojisFixos.push(novaPlanta);
                });
            }
            
            // Se n√£o houver √°rvore no save, adicionar
            if (!emojisFixos.some(e => e.tipo === 'arvore')) {
                emojisFixos.push({
                    emoji: 'üå≥',
                    x: -104,
                    y: 596,
                    size: 200,
                    color: '#228B22',
                    isHovered: false,
                    porcentagem: 100,
                    ativa: true,
                    id: emojisFixos.length,
                    tipo: 'arvore',
                    tempoUltimaColeta: 0,
                    posicoesTriangulo: null
                });
            }
            
            // Se n√£o houver galinha no save, adicionar
            if (!emojisFixos.some(e => e.tipo === 'galinha')) {
                emojisFixos.push({
                    emoji: 'üêì',
                    x: 1550,
                    y: 700,
                    size: 40,
                    color: '#FFD700',
                    isHovered: false,
                    porcentagem: 50,
                    ativa: true,
                    id: emojisFixos.length,
                    tipo: 'galinha',
                    tempoUltimaPostura: 0,
                    posicoesTriangulo: null,
                    indicePosicao: 0
                });
            }
            
            // Carregar item em uso
            itemEmUsoAtual = data.itemEmUsoAtual || null;
            atualizarSlotEquipamentoExterno();
            
            // Carregar sistema de indicadores
            if (data.sistemaIndicadores) {
                SistemaIndicadores.carregarEstado(data.sistemaIndicadores);
            } else {
                SistemaIndicadores.resetar();
            }
            
            // Atualizar imagens conforme n√≠vel da casa
            if (nivelCasaPersonagem > 1) {
                atualizarImagensEstruturas();
            }
            
            // Verificar se j√° houve primeiro contato
            primeiroContatoLideranca = localStorage.getItem('lideranca_contato_inicial') !== 'true';
            
            // Iniciar degrada√ß√£o de plantas e movimentos de animais
            iniciarDegradacaoPlantas();
            iniciarMovimentoAnimais();
            
            atualizarIndicadores();
            atualizarInventario();
            jogoCarregado = true;
            
            console.log('Jogo carregado com sucesso!');
            return true;
        } catch (e) {
            console.error('Erro ao carregar jogo:', e);
            jogoCarregado = false;
            return false;
        }
    }

    // NOVA FUN√á√ÉO: Atualizar slot de equipamento externo
    function atualizarSlotEquipamentoExterno() {
        if (itemEmUsoAtual) {
            itemEmUsoEmoji.textContent = itemEmUsoAtual.emoji;
            itemEmUsoNome.textContent = itemEmUsoAtual.nome;
            itemEmUso.style.display = 'flex';
            itemEmUso.style.opacity = '1';
            itemEmUso.style.pointerEvents = 'auto';
            itemEmUso.setAttribute('title', `Clique para abrir o invent√°rio\nEquipado: ${itemEmUsoAtual.nome}`);
        } else {
            itemEmUso.style.display = 'none';
        }
    }

    function abrirInventario() {
        modalInventario.style.display = 'block';
        // Esconder item em uso enquanto o invent√°rio est√° aberto
        itemEmUso.style.opacity = '0.5';
        itemEmUso.style.pointerEvents = 'none';
        tocarSom('somClique');
    }

    // ATUALIZADA: Fun√ß√£o atualizarInventario - 12 slots (4x3)
    function atualizarInventario() {
        gridInventario.innerHTML = '';
        
        let slotsVazios = 0;
        
        for (let i = 0; i < 12; i++) { // Alterado para 12 slots
            const slot = document.createElement('div');
            slot.className = inventario[i] ? 'slot-inventario' : 'slot-inventario vazio';
            slot.dataset.index = i;
            
            if (inventario[i]) {
                slot.textContent = inventario[i].emoji || '‚ùì';
                slot.title = `${inventario[i].nome || 'Item desconhecido'} (${inventario[i].quantidade}x)`;
                
                // Adicionar quantidade
                const quantidadeDiv = document.createElement('div');
                quantidadeDiv.className = 'slot-quantidade';
                quantidadeDiv.textContent = inventario[i].quantidade;
                slot.appendChild(quantidadeDiv);
            } else {
                slot.textContent = '+';
                slot.title = 'Slot vazio';
                slotsVazios++;
            }
            
            slot.onclick = () => selecionarItemInventario(i);
            gridInventario.appendChild(slot);
        }
        
        // Verificar se o invent√°rio est√° cheio
        if (slotsVazios === 0) {
            setTimeout(() => {
                mostrarMensagemRapida('‚ö†Ô∏è Invent√°rio lotado! Libere espa√ßo para novos itens.');
            }, 300);
        }
        
        // Atualizar slot de equipamento externo
        atualizarSlotEquipamentoExterno();
    }

    // ATUALIZADA: Fun√ß√£o selecionar item do invent√°rio
    function selecionarItemInventario(index) {
        if (!inventario[index]) {
            slotSelecionadoContainer.style.display = 'none';
            itemSelecionadoIndex = -1;
            // Desabilitar bot√µes
            btnConsumir.disabled = true;
            btnUsar.disabled = true;
            btnVender.disabled = true;
            return;
        }
        
        itemSelecionadoIndex = index;
        const item = inventario[index];
        
        slotSelecionadoEmoji.textContent = item.emoji;
        slotSelecionadoNome.textContent = item.nome;
        slotSelecionadoTipo.textContent = `Tipo: ${item.tipo}`;
        slotSelecionadoQuantidade.textContent = `Quantidade: ${item.quantidade}`;
        slotSelecionadoContainer.style.display = 'block';
        
        // Habilitar/desabilitar bot√µes conforme o tipo do item
        btnConsumir.disabled = item.tipo !== 'alimento';
        btnUsar.disabled = false; // Todos os itens podem ser usados
        btnVender.disabled = false;
        
        tocarSom('somClique');
    }

    // ATUALIZADA: Fun√ß√£o consumir item do invent√°rio - reduz apenas uma unidade
    function consumirItem() {
        if (itemSelecionadoIndex === -1 || !inventario[itemSelecionadoIndex]) {
            mostrarMensagemRapida('Nenhum item selecionado!');
            return;
        }
        
        const item = inventario[itemSelecionadoIndex];
        
        if (item.tipo !== 'alimento') {
            mostrarMensagemRapida('Este item n√£o pode ser consumido!');
            return;
        }
        
        if (item.quantidade <= 0) {
            inventario[itemSelecionadoIndex] = null;
            mostrarMensagemRapida('Este alimento acabou!');
            atualizarInventario();
            slotSelecionadoContainer.style.display = 'none';
            itemSelecionadoIndex = -1;
            btnConsumir.disabled = true;
            btnUsar.disabled = true;
            btnVender.disabled = true;
            return;
        }
        
        // Aumentar alimenta√ß√£o entre 5% e 15% com exce√ß√µes especiais
        let aumento = 5 + (Math.random() * 10); // 5 a 15 unidades - consumir itens

        // Casos especiais
        if (item.nome === "Ovo") {
            aumento = 50; // ‚≠ê 50%
        } else if (item.nome === "Frango assado") {
            aumento = 100; // ‚≠ê 100%
        } else if (item.nome === "Peixe") {
            aumento = 80;  // ‚≠ê 80%
        }
        
        SistemaIndicadores.aumentarAlimentacao(aumento);
        
        // Reduzir apenas UMA unidade
        item.quantidade -= 1;
        
        if (item.quantidade <= 0) {
            inventario[itemSelecionadoIndex] = null;
        }
        
        // Mostrar mensagem
        const aumentoPercentual = Math.round(aumento * 100);
        mostrarMensagemRapida(`üçΩÔ∏è Comeu 1x ${item.nome}! Indicador de Alimenta√ß√£o aumentado!`);
        
        // Atualizar invent√°rio
        atualizarInventario();
        
        // Se ainda tem o item, manter selecionado
        if (inventario[itemSelecionadoIndex]) {
            selecionarItemInventario(itemSelecionadoIndex);
        } else {
            slotSelecionadoContainer.style.display = 'none';
            itemSelecionadoIndex = -1;
            btnConsumir.disabled = true;
            btnUsar.disabled = true;
            btnVender.disabled = true;
        }
        
        tocarSom('somClique');
    }

    // ATUALIZADA: Fun√ß√£o usar item - agora fecha o invent√°rio e mostra no slot de uso externo
    function usarItem() {
        if (itemSelecionadoIndex === -1 || !inventario[itemSelecionadoIndex]) {
            mostrarMensagemRapida('Nenhum item selecionado!');
            return;
        }
        
        const item = inventario[itemSelecionadoIndex];
        
        if (item.tipo === 'ferramenta' || item.tipo === 'utensilio') {
            // Usar ferramenta ou utens√≠lio - fixa no slot de uso
            itemEmUsoAtual = {
                emoji: item.emoji,
                nome: item.nome,
                tipo: item.tipo,
                index: itemSelecionadoIndex
            };
            
            // Atualizar slot externo
            atualizarSlotEquipamentoExterno();
            
            // MENSAGEM ESPECIAL PARA CADA ITEM
            let mensagemEspecial = '';
            if (item.nome === "Recipiente de √Ågua") {
                mensagemEspecial = " (+10% de √°gua por coleta)";
            } else if (item.nome === "Enxada") {
                mensagemEspecial = " (+" + (Math.floor(nivelJogador / 10) + 1) + "% por clique em plantas)";
            } else if (item.nome === "Machado") {
                mensagemEspecial = " (+7% por clique em √°rvores)";
            } else if (item.nome === "Faca") {
                mensagemEspecial = " (necess√°ria para abater animais)";
            } else if (item.nome === "Vara de Pesca") {
                mensagemEspecial = " (necess√°ria para pescar)";
            }
            
            mostrarMensagemRapida(`‚úã ${item.nome} equipado!${mensagemEspecial}`);
            tocarSom('somClique');
            
            // FECHAR O INVENT√ÅRIO automaticamente
            fecharModal('modalInventario');
            
    } else if (item.tipo === 'alimento') {
        // Verificar se √© uma semente para broto (üçé,üçã,üçè)
        if (item.nome === "Ma√ß√£" || item.nome === "Lim√£o" || 
            item.nome === "Ma√ß√£ Verde") {
            usarSementeParaBroto(item, itemSelecionadoIndex);
            return;
        }
        
        // Se for ovo, pode ser usado para gerar pintinho
        if (item.nome === "Ovo") {
                // Verificar se h√° espa√ßo no mapa para um pintinho
                // Encontrar a √∫ltima galinha ou pintinho para posicionar perto
                let x = 1600, y = 750; // Posi√ß√£o padr√£o
                
                // Adicionar pintinho ao mapa
                const novoId = emojisFixos.length;
                emojisFixos.push({
                    emoji: 'üê•',
                    x: x,
                    y: y,
                    size: 20,
                    color: '#FFD700',
                    isHovered: false,
                    porcentagem: Math.floor(Math.random() * 21) + 30, // 30-50% inicial
                    ativa: true,
                    id: novoId,
                    tipo: 'pintinho',
                    tempoUltimaPostura: 0,
                    posicoesTriangulo: null,
                    indicePosicao: 0
                });
                
                // Remover o ovo do invent√°rio
                item.quantidade -= 1;
                if (item.quantidade <= 0) {
                    inventario[itemSelecionadoIndex] = null;
                }
                
                mostrarMensagemRapida('üê• Ovo chocou e nasceu um pintinho!');
                atualizarInventario();
                
                // Fechar invent√°rio
                fecharModal('modalInventario');
                
                // Resetar sele√ß√£o
                slotSelecionadoContainer.style.display = 'none';
                itemSelecionadoIndex = -1;
                btnConsumir.disabled = true;
                btnUsar.disabled = true;
                btnVender.disabled = true;
                
                tocarSom('somPlanta');
                return;
            }
            
            // Usar alimento para plantar
            if (item.quantidade <= 0) {
                inventario[itemSelecionadoIndex] = null;
                mostrarMensagemRapida('Este alimento acabou!');
                atualizarInventario();
                slotSelecionadoContainer.style.display = 'none';
                itemSelecionadoIndex = -1;
                btnConsumir.disabled = true;
                btnUsar.disabled = true;
                btnVender.disabled = true;
                return;
            }
            
            // Reduzir apenas UMA unidade
            item.quantidade -= 1;
            
            if (item.quantidade <= 0) {
                inventario[itemSelecionadoIndex] = null;
            }
            
            // Criar nova planta√ß√£o 3x3
            criarNovaPlantacao(item);
            
            mostrarMensagemRapida(`üå± Plantou 1x ${item.nome}! Nova planta√ß√£o criada.`);
            
            // FECHAR O INVENT√ÅRIO automaticamente ap√≥s plantar
            fecharModal('modalInventario');
            
            // Atualizar invent√°rio
            atualizarInventario();
            
            // Resetar sele√ß√£o
            slotSelecionadoContainer.style.display = 'none';
            itemSelecionadoIndex = -1;
            btnConsumir.disabled = true;
            btnUsar.disabled = true;
            btnVender.disabled = true;
            
            tocarSom('somPlanta');
        } else {
            mostrarMensagemRapida('Este item n√£o pode ser usado desta forma!');
        }
    }

// NOVA FUN√á√ÉO: Usar semente para plantar broto
function usarSementeParaBroto(item, index) {
    // Verificar se h√° espa√ßo no invent√°rio (remo√ß√£o da semente)
    if (item.quantidade <= 0) {
        inventario[index] = null;
        mostrarMensagemRapida('Esta semente acabou!');
        atualizarInventario();
        slotSelecionadoContainer.style.display = 'none';
        itemSelecionadoIndex = -1;
        btnConsumir.disabled = true;
        btnUsar.disabled = true;
        btnVender.disabled = true;
        return;
    }
    
    // Reduzir uma unidade da semente
    item.quantidade -= 1;
    
    if (item.quantidade <= 0) {
        inventario[index] = null;
    }
    
    // Criar broto na posi√ß√£o atual do personagem
    const novoId = emojisFixos.length;
    emojisFixos.push({
        emoji: 'üå≥',
        x: player.x,
        y: player.y,
        size: 60,
        color: '#90EE90',
        isHovered: false,
        porcentagem: 10,
        ativa: true,
        id: novoId,
        tipo: 'broto',
        tempoUltimaColeta: 0,
        posicoesTriangulo: null
    });
    
    // Mostrar mensagem especial
    mostrarAlertaSucesso('üå≥ Parab√©ns! Voc√™ plantou um broto e est√° ajudando no reflorestamento do assentamento!');
    
    // Atualizar invent√°rio
    atualizarInventario();
    
    // Fechar invent√°rio
    fecharModal('modalInventario');
    
    // Resetar sele√ß√£o
    slotSelecionadoContainer.style.display = 'none';
    itemSelecionadoIndex = -1;
    btnConsumir.disabled = true;
    btnUsar.disabled = true;
    btnVender.disabled = true;
    
    tocarSom('somPlanta');
}

    // ATUALIZADA: Fun√ß√£o vender item - vende apenas uma unidade
    function venderItem() {
        if (itemSelecionadoIndex === -1 || !inventario[itemSelecionadoIndex]) {
            mostrarMensagemRapida('Nenhum item selecionado!');
            return;
        }
        
        const item = inventario[itemSelecionadoIndex];
        
        // Definir pre√ßo de venda baseado no tipo
        let valorPorUnidade = 0;
        switch(item.tipo) {
            case 'alimento':
                valorPorUnidade = 50;
                break;
            case 'ferramenta':
                valorPorUnidade = 100;
                break;
            case 'utensilio':
                valorPorUnidade = 150;
                break;
            default:
                valorPorUnidade = 30;
        }
        
        // Vender apenas UMA unidade
        const valorTotal = valorPorUnidade;
        dinheiroJogador += valorTotal;
        
        // Reduzir apenas uma unidade
        item.quantidade -= 1;
        
        if (item.quantidade <= 0) {
            inventario[itemSelecionadoIndex] = null;
        }
        
        mostrarMensagemRapida(`üí∞ Vendeu 1x ${item.nome} por R$ ${valorTotal}.`);
        
        // Atualizar indicadores e invent√°rio
        atualizarIndicadores();
        atualizarInventario();
        
        // Se o item ainda existe ap√≥s vender uma unidade, manter selecionado
        if (inventario[itemSelecionadoIndex]) {
            selecionarItemInventario(itemSelecionadoIndex);
        } else {
            slotSelecionadoContainer.style.display = 'none';
            itemSelecionadoIndex = -1;
            btnConsumir.disabled = true;
            btnUsar.disabled = true;
            btnVender.disabled = true;
        }
        
        tocarSom('somDinheiro');
    }

    // MODIFICADA: Criar nova planta√ß√£o 3x3 - agora armazena o alimento base
    function criarNovaPlantacao(item) {
        // Encontrar a posi√ß√£o mais √† direita das planta√ß√µes existentes
        let maxX = 1500;
        let maxY = 850;
        
        emojisFixos.forEach(planta => {
            if (planta.tipo === 'planta' && planta.x > maxX) maxX = planta.x;
            if (planta.tipo === 'planta' && planta.y > maxY) maxY = planta.y;
        });
        
        // Calcular nova posi√ß√£o (50px de dist√¢ncia)
        const startX = maxX + 50;
        const startY = 850; // Mant√©m a mesma linha Y
        
        // Criar 9 novas plantas (3x3) - armazenando o alimento base
        const novoId = emojisFixos.length;
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                emojisFixos.push({
                    emoji: 'üå±',
                    x: startX + (i * 50),
                    y: startY + (j * 50),
                    size: 40,
                    color: '#228B22',
                    isHovered: false,
                    porcentagem: Math.floor(Math.random() * 21) + 50,
                    ativa: true,
                    id: novoId + (i * 3) + j,
                    tipo: 'planta',
                    alimentoBase: { // Armazena qual alimento foi usado para criar
                        emoji: item.emoji,
                        tipo: item.tipo,
                        nome: item.nome
                    }
                });
            }
        }
        
        mostrarMensagemRapida(`üå± Nova planta√ß√£o 3x3 de ${item.nome} criada!`);
    }

    function selecionarCredito(index) {
        document.querySelectorAll('.opcao-credito').forEach(el => {
            el.classList.remove('selecionada');
        });
        
        document.querySelectorAll('.opcao-credito')[index].classList.add('selecionada');
        creditoSelecionado = index;
        tocarSom('somClique');
    }

    function solicitarCredito() {
        if (creditoSelecionado === -1) {
            mostrarMensagemRapida('Selecione uma modalidade de cr√©dito!');
            return;
        }
        
        const modalidades = [
            'Apoio Inicial',
            'Fomento',
            'Fomento Jovem',
            'Fomento Mulher',
            'Semi√°rido',
            'Florestal',
            'Recupera√ß√£o Ambiental',
            'Cacau'
        ];
        
        const modalidade = modalidades[creditoSelecionado];
        mostrarAlertaSucesso(`Cr√©dito "${modalidade}" solicitado com sucesso! Em an√°lise...`);
        
        modalCredito.style.display = 'none';
        creditoSelecionado = -1;
        
        document.querySelectorAll('.opcao-credito').forEach(el => {
            el.classList.remove('selecionada');
        });
    }

    function fecharModal(idModal) {
        document.getElementById(idModal).style.display = 'none';
        
        if (idModal === 'modalInventario') {
            // Restaurar visibilidade do item em uso
            itemEmUso.style.opacity = '1';
            itemEmUso.style.pointerEvents = 'auto';
        }
        
        tocarSom('somClique');
        
        // Se for o modal de conversa, restaurar a imagem dos l√≠deres ap√≥s 3 segundos
        if (idModal === 'modalConversa' && estruturaConversaAtual === 0 && liderancaImagemAlterada) {
            setTimeout(() => {
                restaurarImagemLideranca();
            }, 3000);
        }
    }

    function mostrarMensagemRapida(mensagem) {
        const msg = document.createElement('div');
        msg.style.cssText = `
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            z-index: 1500;
            font-size: 14px;
            animation: aparecerDesaparecer 2s ease-in-out;
            white-space: nowrap;
        `;
        msg.textContent = formatarAssentamento(mensagem);
        
        document.body.appendChild(msg);
        
        setTimeout(() => {
            if (msg.parentNode) {
                msg.parentNode.removeChild(msg);
            }
        }, 4000);
    }

    function mostrarAlerta(emoji, titulo, mensagem) {
        emojiAviso.textContent = emoji;
        tituloAviso.textContent = formatarAssentamento(titulo);
        mensagemAviso.textContent = formatarAssentamento(mensagem);
        alertaAviso.style.display = 'block';
        tocarSom('somAlerta');
    }
    
    function mostrarAlertaPerigo(emoji, titulo, mensagem) {
        emojiPerigo.textContent = emoji;
        tituloPerigo.textContent = formatarAssentamento(titulo);
        mensagemPerigo.textContent = formatarAssentamento(mensagem);
        alertaPerigo.style.display = 'block';
        tocarSom('somAlerta');
    }

    function mostrarAlertaSucesso(mensagem) {
        mensagemSucesso.textContent = formatarAssentamento(mensagem);
        alertaSucesso.style.display = 'block';
        tocarSom('somSucesso');
    }

    function fecharAlerta(idAlerta) {
        document.getElementById(idAlerta).style.display = 'none';
        tocarSom('somClique');
    }

    function acaoPlanta() {
        if (plantaSelecionada === -1) return;
        
        const planta = emojisFixos.find(p => p.id === plantaSelecionada);
        if (!planta || !planta.ativa) return;
        
        if (planta.tipo === 'planta') {
            planta.ativa = false;
            menuPlanta.style.display = 'none';
            plantaSelecionada = -1;
            fazerAlgoRuim("Destruiu uma planta saud√°vel!");
        } else if (planta.tipo === 'dinheiro') {
            const valorGanho = 10; // VALOR FIXO DE R$ 10 TRABALHO
    dinheiroJogador += valorGanho;
            
            SistemaIndicadores.aumentarVinculo(50);
            
            planta.ativa = false;
            menuPlanta.style.display = 'none';
            plantaSelecionada = -1;
            
            mostrarAlertaSucesso(`Voc√™ acaba de ganhar +${valorGanho} reais pela venda.`);
            atualizarIndicadores();
            tocarSom('somDinheiro');
        } else if (planta.tipo === 'arvore') {
            // Coletar fruta/isca da √°rvore
            const agora = Date.now();
            if (planta.tempoUltimaColeta && (agora - planta.tempoUltimaColeta) < 60000) {
                mostrarMensagemRapida('Nada na √°rvore, volte mais tarde.');
                menuPlanta.style.display = 'none';
                plantaSelecionada = -1;
                return;
            }
            
            // Atualizar o tempo da √∫ltima coleta
            planta.tempoUltimaColeta = agora;
            
            // Gerar item aleat√≥rio
            const itensPossiveis = [
                { emoji: 'üçé', nome: 'Ma√ß√£', tipo: 'alimento' },
                { emoji: 'üçã', nome: 'Lim√£o', tipo: 'alimento' },
                { emoji: 'üçè', nome: 'Ma√ß√£ Verde', tipo: 'alimento' },
                { emoji: 'üêõ', nome: 'Isca', tipo: 'alimento' }
            ];
            const itemAleatorio = itensPossiveis[Math.floor(Math.random() * itensPossiveis.length)];
            
            // Adicionar ao invent√°rio
            const slotVazio = inventario.findIndex(item => item === null);
            if (slotVazio !== -1) {
                inventario[slotVazio] = {
                    emoji: itemAleatorio.emoji,
                    tipo: itemAleatorio.tipo,
                    nome: itemAleatorio.nome,
                    quantidade: 1
                };
                mostrarMensagemRapida(`Voc√™ coletou: ${itemAleatorio.emoji} ${itemAleatorio.nome}`);
                atualizarInventario();
            } else {
                mostrarMensagemRapida('Invent√°rio cheio! N√£o foi poss√≠vel coletar o item.');
            }
            
            menuPlanta.style.display = 'none';
            plantaSelecionada = -1;
            tocarSom('somClique');
        } else if (planta.tipo === 'galinha') {
            // Verificar se a faca est√° equipada
            if (!itemEmUsoAtual || itemEmUsoAtual.nome !== "Faca") {
                mostrarMensagemRapida("Voc√™ precisa usar üî™Faca para realizar o abate!");
                menuPlanta.style.display = 'none';
                plantaSelecionada = -1;
                return;
            }
            
            // Mostrar efeito da faca
            mostrarEfeitoFerramenta();
            
            planta.ativa = false;
            
            // Adicionar frango assado ao invent√°rio
            const slotVazio = inventario.findIndex(item => item === null);
            if (slotVazio !== -1) {
                inventario[slotVazio] = {
                    emoji: "üçó",
                    tipo: "alimento",
                    nome: "Frango assado",
                    quantidade: 1
                };
                mostrarMensagemRapida('üçó Realizou abate da galinha! (Frango assado adicionado)');
                atualizarInventario();
            } else {
                mostrarMensagemRapida('Invent√°rio cheio! N√£o foi poss√≠vel coletar o frango assado.');
            }
            
            menuPlanta.style.display = 'none';
            plantaSelecionada = -1;
            tocarSom('somClique');
        } else if (planta.tipo === 'pintinho') {
            // Coletar pintinho (vender por dinheiro)
            const valor = 5;
            dinheiroJogador += valor;
            planta.ativa = false;
            mostrarMensagemRapida(`üí∞ Pintinho vendido por R$ ${valor}.`);
            atualizarIndicadores();
            menuPlanta.style.display = 'none';
            plantaSelecionada = -1;
            tocarSom('somDinheiro');
} else if (planta.tipo === 'broto') {
        planta.ativa = false;
        menuPlanta.style.display = 'none';
        plantaSelecionada = -1;
        fazerAlgoRuim("Removeu um broto que ajudava no reflorestamento!");
    }
}

    // ATUALIZADA: Fun√ß√£o desenvolver planta - agora inclui √°rvore e galinha

function desenvolverPlanta() {
    if (plantaSelecionada === -1) return;
    
    const planta = emojisFixos.find(p => p.id === plantaSelecionada);
    if (!planta || !planta.ativa) return;
    
    if (planta.tipo === 'planta') {
        // VERIFICAR SE A ENXADA EST√Å EQUIPADA
        if (!itemEmUsoAtual || itemEmUsoAtual.nome !== "Enxada") {
            mostrarMensagemRapida("Voc√™ precisa usar ‚õèÔ∏è Enxada para desenvolver a planta√ß√£o!");
            return;
        }
        
        if (SistemaIndicadores.estado.agua < 0.02 || 
            SistemaIndicadores.estado.alimentacao < 0.015 ||
            SistemaIndicadores.estado.descanso < 0.01) {
            mostrarMensagemRapida('Recursos insuficientes para desenvolver a planta!');
            return;
        }
        
        // Mostrar efeito da enxada
        mostrarEfeitoFerramenta();
        
        SistemaIndicadores.consumirRecursos(0.02, 0.015, 0.01);
        
        const incrementoBase = 5; // Base de 5% por cliques no trabalho para desenvolver plantas
        const bonusPorNivel = Math.floor(nivelJogador / 10); // +1% a cada 10 n√≠veis
        const incremento = incrementoBase + bonusPorNivel;

        planta.porcentagem = Math.min(100, planta.porcentagem + incremento);
        
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        if (planta.porcentagem >= 100) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
            transformarEmDinheiro(planta);
            configurarMenuPlanta(planta);
            SistemaIndicadores.aumentarVinculo(100);
        } else if (planta.porcentagem >= 70) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #32CD32, #228B22)';
        } else if (planta.porcentagem >= 40) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #90EE90, #32CD32)';
        }
        
        SistemaIndicadores.atualizarInterface();
        tocarSom('somPlanta');
        
    } else if (planta.tipo === 'broto') {
        // Desenvolver broto (n√£o requer ferramenta equipada)
        if (SistemaIndicadores.estado.agua < 0.02 || 
            SistemaIndicadores.estado.alimentacao < 0.015 ||
            SistemaIndicadores.estado.descanso < 0.01) {
            mostrarMensagemRapida('Recursos insuficientes para desenvolver o broto!');
            return;
        }
        
        SistemaIndicadores.consumirRecursos(0.02, 0.015, 0.01);
        
        const incrementoBase = 5;
        const bonusPorNivel = Math.floor(nivelJogador / 10);
        const incremento = incrementoBase + bonusPorNivel;
        
        planta.porcentagem = Math.min(100, planta.porcentagem + incremento);
        
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        if (planta.porcentagem >= 100) {
            // Transformar broto em √°rvore - CORRE√á√ÉO AQUI
            planta.tipo = 'arvore';
            planta.size = 200; // Tamanho da √°rvore
            planta.color = '#228B22';
            planta.porcentagem = 100;
            planta.ativa = true; // Garantir que continua ativa
            
            // Fechar o menu da planta automaticamente
            menuPlanta.style.display = 'none';
            plantaSelecionada = -1;
            
            mostrarMensagemRapida('üå≥ O broto cresceu e se tornou uma √°rvore!');
            SistemaIndicadores.aumentarVinculo(10); // Recompensa por fazer crescer uma √°rvore
        } else if (planta.porcentagem >= 70) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #32CD32, #228B22)';
        } else if (planta.porcentagem >= 40) {
            barraProgressoPlanta.style.background = 'linear-gradient(90deg, #90EE90, #32CD32)';
        }
        
        SistemaIndicadores.atualizarInterface();
        tocarSom('somPlanta');
        
    } else if (planta.tipo === 'arvore') {
        // Derrubar √°rvore
        if (!itemEmUsoAtual || itemEmUsoAtual.nome !== "Machado") {
            mostrarMensagemRapida("Voc√™ precisa usar ü™ì Machado para derrubar a √°rvore!");
            return;
        }
        
        if (SistemaIndicadores.estado.agua < 0.03 || 
            SistemaIndicadores.estado.alimentacao < 0.02 ||
            SistemaIndicadores.estado.descanso < 0.01) {
            mostrarMensagemRapida('Recursos insuficientes para derrubar a √°rvore!');
            return;
        }
        
        // Mostrar efeito do machado
        mostrarEfeitoFerramenta();
        
        // Consumo baseado no incremento
        const consumoAgua = 0.02 + (7 * 0.001); // 2% + 0,1% por % de incremento
        const consumoAlimentacao = 0.015 + (7 * 0.0008); // 1,5% + 0,08% por % de incremento
        const consumoDescanso = 0.01 + (7 * 0.0005); // 1% + 0,05% por % de incremento

        SistemaIndicadores.consumirRecursos(consumoAgua, consumoAlimentacao, consumoDescanso);
        
        const incrementoArvore = 7; // 7% por clique
        planta.porcentagem = Math.max(0, planta.porcentagem - incrementoArvore);
        
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        if (planta.porcentagem <= 0) {
            // √Årvore derrubada
            planta.tipo = 'dinheiro';
            planta.emoji = 'üí∞';
            planta.color = '#FFD700';
            planta.size = 45;
            
            // EXCE√á√ÉO: Derrubar √°rvore reduz v√≠nculo em 25% (n√£o 2%)
            SistemaIndicadores.reduzirVinculo(25); // 25 * 0.01 = 0.25 (25%)
            
            configurarMenuPlanta(planta);
            
            // Mostrar alerta vermelho pelo crime ambiental
            mostrarAlertaPerigo('üö´', 'CRIME AMBIENTAL!', 'Voc√™ derrubou uma √°rvore protegida! Venda de madeira de lei √© crime! V√≠nculo com a comunidade reduzido em 25%.');
            
            tocarSom('somAlerta');
        }
        
        SistemaIndicadores.atualizarInterface();
        tocarSom('somPlanta');
        
    } else if (planta.tipo === 'galinha') {
        // Alimentar galinha
        // Verificar se tem milho no invent√°rio
        const indexMilho = inventario.findIndex(item => item && item.nome === "Milho");
        if (indexMilho === -1 || inventario[indexMilho].quantidade <= 0) {
            mostrarMensagemRapida('Voc√™ precisa de üåΩ Milho para alimentar a galinha!');
            return;
        }
        
        // Consumir 1 milho
        inventario[indexMilho].quantidade -= 1;
        if (inventario[indexMilho].quantidade <= 0) {
            inventario[indexMilho] = null;
        }
        atualizarInventario();
        
        // Aumentar a porcentagem da galinha
        const incrementoGalinha = 7;
        planta.porcentagem = Math.min(100, planta.porcentagem + incrementoGalinha);
        
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        if (planta.porcentagem >= 100) {
            // Produzir ovo
            planta.porcentagem = 50; // Resetar para 50%
            
            // Adicionar ovo ao invent√°rio
            const slotVazio = inventario.findIndex(item => item === null);
            if (slotVazio !== -1) {
                inventario[slotVazio] = {
                    emoji: "ü•ö",
                    tipo: "alimento",
                    nome: "Ovo",
                    quantidade: 1
                };
                mostrarMensagemRapida('ü•ö A galinha produziu um ovo!');
            } else {
                mostrarMensagemRapida('ü•ö A galinha produziu um ovo, mas seu invent√°rio est√° cheio!');
            }
            atualizarInventario();
        }
        
        tocarSom('somPlanta');
        
    } else if (planta.tipo === 'pintinho') {
        // Desenvolver pintinho
        const indexMilho = inventario.findIndex(item => item && item.nome === "Milho");
        if (indexMilho === -1 || inventario[indexMilho].quantidade <= 0) {
            mostrarMensagemRapida('Voc√™ precisa de üåΩ Milho para alimentar o pintinho!');
            return;
        }
        
        inventario[indexMilho].quantidade -= 1;
        if (inventario[indexMilho].quantidade <= 0) {
            inventario[indexMilho] = null;
        }
        atualizarInventario();
        
        const incrementoPintinho = 25;
        planta.porcentagem = Math.min(100, planta.porcentagem + incrementoPintinho);
        
        porcentagemPlanta.textContent = planta.porcentagem;
        barraProgressoPlanta.style.width = `${planta.porcentagem}%`;
        barraProgressoPlanta.textContent = `${planta.porcentagem}%`;
        
        if (planta.porcentagem >= 100) {
            // Pintinho vira galinha
            planta.tipo = 'galinha';
            planta.emoji = 'üêì';
            planta.size = 60;
            planta.porcentagem = 50; // Nova galinha come√ßa com 50%
            mostrarMensagemRapida('üêì O pintinho cresceu e virou uma galinha!');
        }
        
        tocarSom('somPlanta');
    }
}

    // NOVA FUN√á√ÉO: Mostrar efeito de ferramenta sobre o personagem
    function mostrarEfeitoFerramenta() {
        if (!itemEmUsoAtual) return;
        
        const efeito = document.createElement('div');
        efeito.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            font-size: 60px;
            pointer-events: none;
            z-index: 1500;
        `;
        
        // Efeito especial para cada ferramenta
        let emojiFerramenta = itemEmUsoAtual.emoji;
        let animacao = 'subirDesaparecer 1.5s ease-out';
        
        // Anima√ß√£o especial para a vara de pesca
        if (itemEmUsoAtual.nome === "Vara de Pesca") {
            animacao = 'pescarAnimacao 2s ease-in-out';
            efeito.style.fontSize = '80px';
        }
        
        // Anima√ß√£o especial para o machado
        if (itemEmUsoAtual.nome === "Machado") {
            animacao = 'machadoAnimacao 1s ease-in-out';
            efeito.style.fontSize = '70px';
        }
        
        // Anima√ß√£o especial para a faca
        if (itemEmUsoAtual.nome === "Faca") {
            animacao = 'facaAnimacao 0.8s ease-in-out';
            efeito.style.fontSize = '60px';
        }
        
        // Anima√ß√£o especial para a enxada
        if (itemEmUsoAtual.nome === "Enxada") {
            animacao = 'enxadaAnimacao 1.2s ease-in-out';
            efeito.style.fontSize = '65px';
        }
        
        // Anima√ß√£o especial para o martelo
        if (itemEmUsoAtual.nome === "Martelo") {
            animacao = 'marteloAnimacao 1s ease-in-out';
            efeito.style.fontSize = '70px';
        }
        
        // Anima√ß√£o especial para o recipiente de √°gua
        if (itemEmUsoAtual.nome === "Recipiente de √Ågua") {
            animacao = 'recipienteAnimacao 1.5s ease-in-out';
            efeito.style.fontSize = '60px';
        }
        
        efeito.textContent = emojiFerramenta;
        efeito.style.animation = animacao;
        
        document.body.appendChild(efeito);
        
        setTimeout(() => {
            if (efeito.parentNode) {
                efeito.parentNode.removeChild(efeito);
            }
        }, 2000);
    }

    function abrirMenuBarraca(x, y) {
    menuBarraca.style.display = 'block';
    
    // ‚≠ê DESATIVAR INTERA√á√ÉO COM O MENU POR 100ms
    menuBarraca.style.pointerEvents = 'none';
    
    // ‚≠ê REATIVAR AP√ìS 100ms
    setTimeout(() => {
        menuBarraca.style.pointerEvents = 'auto';
    }, 100);
    
    tocarSom('somClique');
}

    function abrirMenuPlanta(x, y) {
    menuPlanta.style.display = 'block';
    
    // ‚≠ê DESATIVAR INTERA√á√ÉO COM O MENU POR 100ms
    menuPlanta.style.pointerEvents = 'none';  // Bloqueia cliques
    
    // ‚≠ê REATIVAR AP√ìS 100ms
    setTimeout(() => {
        menuPlanta.style.pointerEvents = 'auto';  // Permite cliques novamente
    }, 100);  // 100 milissegundos
    
    tocarSom('somClique');
}

    // CORRIGIDA: Fun√ß√£o coletar √°gua - aumenta 15% quando Recipiente de √Ågua est√° equipado
    function coletarAgua() {
        // Verificar se o Recipiente de √Ågua est√° equipado
        let aumento = 5; // ‚≠ê 5% (5 unidades √ó 0,01 = 5%)
        let emoji = 'üíß';
        let mensagem = 'üíß √Ågua coletada (+5%)';
        
        // EXCE√á√ÉO: Recipiente de √Ågua aumenta em 15%
        if (itemEmUsoAtual && itemEmUsoAtual.nome === "Recipiente de √Ågua") {
            aumento = 100; // ‚≠ê 100% com recipiente
            emoji = 'üö∞';
            mensagem = 'üö∞ √Ågua coletada com recipiente (100%)';
            
            // Mostrar efeito do recipiente
            mostrarEfeitoFerramenta();
        }
        
        SistemaIndicadores.aumentarAgua(aumento);
        
        // Mostrar efeito visual
        const efeito = document.createElement('div');
        efeito.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            font-size: 40px;
            pointer-events: none;
            z-index: 1500;
            animation: subirDesaparecer 2s ease-out;
        `;
        efeito.textContent = emoji;
        document.body.appendChild(efeito);
        
        setTimeout(() => {
            if (efeito.parentNode) {
                efeito.parentNode.removeChild(efeito);
            }
        }, 2000);
        
        mostrarMensagemRapida(mensagem);
        tocarSom('somClique');
    }

    // NOVA FUN√á√ÉO: Pescar no a√ßude
    function pescar() {
        // Verificar se tem vara de pesca equipada
        if (!itemEmUsoAtual || itemEmUsoAtual.nome !== "Vara de Pesca") {
            mostrarMensagemRapida("üé£ Voc√™ precisa da Vara de Pesca equipada para pescar!");
            return;
        }
        
        // Verificar se tem isca no invent√°rio
        const indexIsca = inventario.findIndex(item => item && item.nome === "Isca");
        if (indexIsca === -1 || inventario[indexIsca].quantidade <= 0) {
            mostrarMensagemRapida("üêõ Voc√™ precisa de Isca no invent√°rio para pescar!");
            return;
        }
        
        // Mostrar efeito da vara de pesca
        mostrarEfeitoFerramenta();
        
        // Consumir 1 isca
        inventario[indexIsca].quantidade -= 1;
        if (inventario[indexIsca].quantidade <= 0) {
            inventario[indexIsca] = null;
        }
        
        // Adicionar peixe ao invent√°rio
        const slotVazio = inventario.findIndex(item => item === null);
        if (slotVazio !== -1) {
            inventario[slotVazio] = {
                emoji: "üêü",
                tipo: "alimento",
                nome: "Peixe",
                quantidade: 1
            };
            mostrarMensagemRapida('üêü Peixe capturado (-1 isca no invent√°rio) üêõ');
        } else {
            mostrarMensagemRapida('üêü Peixe capturado, mas invent√°rio cheio! (-1 isca) üêõ');
        }
        
        atualizarInventario();
        tocarSom('somClique');
    }

    function fazerAlgoRuim(acao = "Pegou algo sem pedir!") {
        SistemaIndicadores.reduzirVinculo(25); // 25 * 0.01 = 25%
        mostrarMensagemRapida(`‚ö†Ô∏è ${acao}`);
        
        const penalidade = document.createElement('div');
        penalidade.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            pointer-events: none;
            z-index: 1500;
            animation: tremerDesaparecer 1.5s ease-out;
        `;
        penalidade.textContent = '‚ö†Ô∏è';
        
        document.body.appendChild(penalidade);
        
        setTimeout(() => {
            if (penalidade.parentNode) {
                penalidade.parentNode.removeChild(penalidade);
            }
        }, 1500);
        
        tocarSom('somAlerta');
    }

    // Fun√ß√£o para tocar sons
    function tocarSom(idSom) {
        try {
            const somUrls = {
                'somClique': 'https://assets.mixkit.co/sfx/download/mixkit-select-click-1109.mp3',
                'somSucesso': 'https://assets.mixkit.co/sfx/download/mixkit-winning-chimes-2015.mp3',
                'somDinheiro': 'https://assets.mixkit.co/sfx/download/mixkit-cash-register-purchase-875.mp3',
                'somPlanta': 'https://assets.mixkit.co/sfx/download/mixkit-plant-growing-833.mp3',
                'somGameOver': 'https://assets.mixkit.co/sfx/download/mixkit-sad-game-over-trombone-471.mp3',
                'somAlerta': 'https://assets.mixkit.co/sfx/download/mixkit-warning-alarm-buzzer-1658.mp3',
                'somDormir': 'https://assets.mixkit.co/sfx/download/mixkit-sleeping-snore-1130.mp3'
            };
            
            if (!audioCache[idSom]) {
                audioCache[idSom] = new Audio(somUrls[idSom]);
                audioCache[idSom].preload = 'auto';
            }
            
            const audio = audioCache[idSom];
            audio.currentTime = 0;
            audio.volume = 0.7;
            
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log(`√Åudio bloqueado, tentando carregar novamente: ${idSom}`, error);
                    audio.load();
                    audio.play().catch(e => console.log(`N√£o foi poss√≠vel tocar ${idSom}:`, e));
                });
            }
        } catch (e) {
            console.log('Erro ao tocar som:', e);
        }
    }

    // NOVA FUN√á√ÉO: Degrada√ß√£o de plantas (perdem 1-3% a cada 30 segundos)

function degradacaoPlantas() {
    let plantasMortas = 0;
    emojisFixos.forEach(planta => {
        if (planta.ativa && (planta.tipo === 'planta' || planta.tipo === 'galinha' || 
            planta.tipo === 'pintinho' || planta.tipo === 'broto')) {
            // Reduz entre 1% e 3%
            const reducao = 1 + Math.floor(Math.random() * 3);
            planta.porcentagem = Math.max(0, planta.porcentagem - reducao);
            
            if (planta.porcentagem <= 0) {
                planta.ativa = false;
                plantasMortas++;
            }
        }
    });
    
    if (plantasMortas > 0) {
        mostrarMensagemRapida(`Aten√ß√£o: algo est√° morrendo por falta de cuidado!!`);
        // Reduzir o v√≠nculo
        SistemaIndicadores.reduzirVinculo(plantasMortas * 15);
    }
}

    // NOVA FUN√á√ÉO: Iniciar degrada√ß√£o de plantas
    function iniciarDegradacaoPlantas() {
        setInterval(degradacaoPlantas, 30000); // 30 segundos
    }

    // NOVA FUN√á√ÉO: Movimento dos animais
    function atualizarMovimentoAnimais() {
        emojisFixos.forEach(animal => {
            if (animal.ativa && (animal.tipo === 'galinha' || animal.tipo === 'pintinho')) {
                // Se n√£o tiver as propriedades de tri√¢ngulo, inicializa
                if (!animal.posicoesTriangulo) {
                    if (animal.tipo === 'galinha') {
                        animal.posicoesTriangulo = [
                            { x: 1550, y: 700 },
                            { x: 1600, y: 750 },
                            { x: 1600, y: 700 }
                        ];
                    } else if (animal.tipo === 'pintinho') {
                        animal.posicoesTriangulo = [
                            { x: 1600, y: 750 },
                            { x: 1650, y: 800 },
                            { x: 1650, y: 750 }
                        ];
                    }
                    animal.indicePosicao = 0;
                }
                
                // Muda para a pr√≥xima posi√ß√£o
                animal.indicePosicao = (animal.indicePosicao + 1) % 3;
                const novaPos = animal.posicoesTriangulo[animal.indicePosicao];
                animal.x = novaPos.x;
                animal.y = novaPos.y;
            }
        });
    }

    // NOVA FUN√á√ÉO: Iniciar movimento dos animais
    function iniciarMovimentoAnimais() {
        setInterval(atualizarMovimentoAnimais, 2000); // 2 segundos
    }

    // NOVA FUN√á√ÉO: Trocar personagem
    function trocarPersonagem(novoPersonagem) {
        personagemAtual = novoPersonagem;
        
        // Atualizar visual dos seletores
        document.querySelectorAll('.emoji-personagem').forEach(sel => {
            sel.classList.remove('selecionado');
            if (sel.dataset.personagem === novoPersonagem) {
                sel.classList.add('selecionado');
            }
        });
        
        // Mostrar mensagem
        let nomePersonagem = '';
        switch(novoPersonagem) {
            case 'pai': nomePersonagem = 'üöπ Pai'; break;
            case 'mae': nomePersonagem = 'üö∫ M√£e'; break;
            case 'filho': nomePersonagem = 'üöº Filho'; break;
        }
        mostrarMensagemRapida(`Personagem: ${nomePersonagem}`);
        tocarSom('somClique');
    }

    function reiniciarJogo() {
        gameOver = false;
        nivelJogador = 1;
        dinheiroJogador = 0;
        plantasTransformadas = 0;
        nivelCasaPersonagem = 1;
        progressoReforma = 0;
        inventario = Array(12).fill(null);
        jogoCarregado = false;
        primeiroContatoLideranca = true;
        itemSelecionadoIndex = -1;
        itemEmUsoAtual = null;
        personagemAtual = 'pai';
        
        // Atualizar seletores de personagem
        document.querySelectorAll('.emoji-personagem').forEach(sel => {
            sel.classList.remove('selecionado');
            if (sel.dataset.personagem === 'pai') {
                sel.classList.add('selecionado');
            }
        });
        
        // Remover marca√ß√£o de primeiro contato
        localStorage.removeItem('lideranca_contato_inicial');
        
        // Resetar emojis fixos
        emojisFixos = [
            { emoji: 'üå±', x: 1500, y: 850, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 11) + 10, ativa: true, id: 0, tipo: 'planta' },
            { emoji: 'üå±', x: 1550, y: 850, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 1, tipo: 'planta' },
            { emoji: 'üå±', x: 1600, y: 850, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 2, tipo: 'planta' },
            { emoji: 'üå±', x: 1500, y: 900, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 3, tipo: 'planta' },
            { emoji: 'üå±', x: 1550, y: 900, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 4, tipo: 'planta' },
            { emoji: 'üå±', x: 1600, y: 900, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 5, tipo: 'planta' },
            { emoji: 'üå±', x: 1500, y: 950, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 6, tipo: 'planta' },
            { emoji: 'üå±', x: 1550, y: 950, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 7, tipo: 'planta' },
            { emoji: 'üå±', x: 1600, y: 950, size: 40, color: '#228B22', isHovered: false, porcentagem: Math.floor(Math.random() * 21) + 30, ativa: true, id: 8, tipo: 'planta' },
            // √Årvore
            { emoji: 'üå≥', x: -104, y: 596, size: 200, color: '#228B22', isHovered: false, porcentagem: 100, ativa: true, id: 9, tipo: 'arvore', tempoUltimaColeta: 0, posicoesTriangulo: null },
            // Galinha
            { emoji: 'üêì', x: 1550, y: 700, size: 40, color: '#FFD700', isHovered: false, porcentagem: 50, ativa: true, id: 10, tipo: 'galinha', tempoUltimaPostura: 0, posicoesTriangulo: null, indicePosicao: 0 }
        ];
        
        SistemaIndicadores.resetar();
        atualizarImagensEstruturas();
        
        player.x = canvasW / 2;
        player.y = canvasH / 2;
        player.targetX = canvasW / 2;
        player.targetY = canvasH / 2;
        player.isMoving = false;
        
        cameraX = 0;
        cameraY = 0;
        
        // Restaurar imagem dos l√≠deres
        restaurarImagemLideranca();
        
        // Iniciar degrada√ß√£o de plantas e movimentos de animais
        iniciarDegradacaoPlantas();
        iniciarMovimentoAnimais();
        
        atualizarIndicadores();
        atualizarInventario();
        
        // Esconder item em uso
        itemEmUso.style.display = 'none';
        slotSelecionadoContainer.style.display = 'none';
        
        // Esconder telas de fim
        telaGameOver.style.display = 'none';
        telaFimEspecial.style.display = 'none';
        
        mostrarAlertaSucesso('Jogo reiniciado com sucesso!');
    }

    // ============================================
    // FUN√á√ïES DE NAVEGA√á√ÉO
    // ============================================
    
    // Mostrar coordenadas
    function mostrarCoordenadas() {
        coordenadasVisiveis = true;
        coordenadasDisplay.style.display = 'block';
        miniMapaBtn.style.display = 'none';
        resetInactivityTimer();
    }

    // Esconder coordenadas
    function esconderCoordenadas() {
        coordenadasVisiveis = false;
        coordenadasDisplay.style.display = 'none';
        miniMapaBtn.style.display = 'flex';
    }

    // Atualizar valores das coordenadas
    function atualizarCoordenadas() {
        if (coordenadasVisiveis) {
            coordXElement.textContent = Math.round(player.x);
            coordYElement.textContent = Math.round(player.y);
        }
    }

    // Reiniciar timer de inatividade
    function resetInactivityTimer() {
        ultimaAtividade = Date.now();
        
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
        }
        
        inactivityTimer = setInterval(verificarInatividade, 1000);
    }

    // Verificar se o jogador est√° inativo h√° mais de 5 segundos
    function verificarInatividade() {
        const agora = Date.now();
        const tempoInativo = agora - ultimaAtividade;
        
        if (tempoInativo > 5000 && coordenadasVisiveis) {
            esconderCoordenadas();
            clearInterval(inactivityTimer);
            inactivityTimer = null;
        }
    }

function drawEmojis() {
    emojisFixos.forEach(emojiObj => {
        if (!emojiObj.ativa) return;
        
        // √Årvore √© desenhada separadamente (chamada depois)
        if (emojiObj.tipo === 'arvore') return;
        
        const emojiScreenX = emojiObj.x - cameraX;
        const emojiScreenY = emojiObj.y - cameraY;
        
        if (emojiScreenX > -50 && emojiScreenX < canvasW + 50 && 
            emojiScreenY > -50 && emojiScreenY < canvasH + 50) {
            
            ctx.font = `${emojiObj.size}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", Arial, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.lineWidth = 2;
            ctx.strokeText(emojiObj.emoji, emojiScreenX, emojiScreenY);
            
            ctx.fillStyle = emojiObj.color;
            ctx.fillText(emojiObj.emoji, emojiScreenX, emojiScreenY);
            
            if (emojiObj.isHovered) {
                ctx.shadowColor = emojiObj.tipo === 'broto' ? 'rgba(144, 238, 144, 0.7)' :
                                 emojiObj.emoji === 'üí∞' ? 'rgba(255, 215, 0, 0.7)' : 
                                 emojiObj.emoji === 'üêì' || emojiObj.emoji === 'üê•' ? 'rgba(255, 215, 0, 0.5)' : 
                                 'rgba(0, 255, 0, 0.5)';
                ctx.shadowBlur = 15;
                ctx.fillText(emojiObj.emoji, emojiScreenX, emojiScreenY);
                ctx.shadowBlur = 0;
            }
            
            // Efeitos especiais para cada tipo
            if (emojiObj.tipo === 'planta') {
                const pulse = Math.sin(Date.now() / 1000) * 0.05 + 1;
                ctx.save();
                ctx.translate(emojiScreenX, emojiScreenY);
                ctx.scale(pulse, pulse);
                ctx.translate(-emojiScreenX, -emojiScreenY);
                ctx.fillText(emojiObj.emoji, emojiScreenX, emojiScreenY);
                ctx.restore();
                
                ctx.font = 'bold 12px Arial';
                ctx.fillStyle = emojiObj.porcentagem < 30 ? '#FF4444' : 
                               emojiObj.porcentagem < 70 ? '#FFA500' : '#FFFFFF';
                ctx.fillText(`${emojiObj.porcentagem}%`, emojiScreenX, emojiScreenY + 30);
                
            } else if (emojiObj.tipo === 'dinheiro') {
                const brilho = Math.sin(Date.now() / 300) * 0.3 + 0.7;
                ctx.save();
                ctx.globalAlpha = brilho;
                ctx.fillText(emojiObj.emoji, emojiScreenX, emojiScreenY);
                ctx.restore();
                
            } else if (emojiObj.tipo === 'broto') {
                const pulse = Math.sin(Date.now() / 1000) * 0.1 + 1;
                ctx.save();
                ctx.translate(emojiScreenX, emojiScreenY);
                ctx.scale(pulse, pulse);
                ctx.translate(-emojiScreenX, -emojiScreenY);
                ctx.fillText(emojiObj.emoji, emojiScreenX, emojiScreenY);
                ctx.restore();
                
                ctx.font = 'bold 12px Arial';
                ctx.fillStyle = emojiObj.porcentagem < 30 ? '#FF4444' : 
                               emojiObj.porcentagem < 70 ? '#FFA500' : '#FFFFFF';
                ctx.fillText(`${emojiObj.porcentagem}%`, emojiScreenX, emojiScreenY + 35);
                
            } else if (emojiObj.tipo === 'galinha' || emojiObj.tipo === 'pintinho') {
                const pulse = Math.sin(Date.now() / 1000) * 0.05 + 1;
                ctx.save();
                ctx.translate(emojiScreenX, emojiScreenY);
                ctx.scale(pulse, pulse);
                ctx.translate(-emojiScreenX, -emojiScreenY);
                ctx.fillText(emojiObj.emoji, emojiScreenX, emojiScreenY);
                ctx.restore();
                
                ctx.font = 'bold 12px Arial';
                ctx.fillStyle = emojiObj.porcentagem < 30 ? '#FF4444' : 
                               emojiObj.porcentagem < 70 ? '#FFA500' : '#FFFFFF';
                const offsetY = emojiObj.tipo === 'galinha' ? 35 : 25;
                ctx.fillText(`${emojiObj.porcentagem}%`, emojiScreenX, emojiScreenY + offsetY);
            }
        }
    });
}

function drawTreeOnly() {
    emojisFixos.forEach(emoji => {
        if (emoji.ativa && emoji.tipo === 'arvore') {
            const emojiScreenX = emoji.x - cameraX;
            const emojiScreenY = emoji.y - cameraY;
            
            if (emojiScreenX > -50 && emojiScreenX < canvasW + 50 && 
                emojiScreenY > -50 && emojiScreenY < canvasH + 50) {
                
                ctx.font = `${emoji.size}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", Arial, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.strokeText(emoji.emoji, emojiScreenX, emojiScreenY);
                
                ctx.fillStyle = emoji.color;
                ctx.fillText(emoji.emoji, emojiScreenX, emojiScreenY);
                
                if (emoji.isHovered) {
                    ctx.shadowColor = 'rgba(0, 128, 0, 0.5)';
                    ctx.shadowBlur = 15;
                    ctx.fillText(emoji.emoji, emojiScreenX, emojiScreenY);
                    ctx.shadowBlur = 0;
                }
                
                const pulse = Math.sin(Date.now() / 1500) * 0.1 + 1;
                ctx.save();
                ctx.translate(emojiScreenX, emojiScreenY);
                ctx.scale(pulse, pulse);
                ctx.translate(-emojiScreenX, -emojiScreenY);
                ctx.fillText(emoji.emoji, emojiScreenX, emojiScreenY);
                ctx.restore();
                
                ctx.font = 'bold 14px Arial';
                ctx.fillStyle = emoji.porcentagem < 30 ? '#FF4444' : 
                               emoji.porcentagem < 70 ? '#FFA500' : '#FFFFFF';
                ctx.fillText(`${emoji.porcentagem}%`, emojiScreenX, emojiScreenY + 50);
            }
        }
    });
}

    function update(time) {
        if (gameOver) return;
        
        const deltaTime = lastTime ? time - lastTime : 0;
        lastTime = time;

        if (player.isMoving) {
            walkFrameTimer += deltaTime;
            if (walkFrameTimer >= ANIMATION_SPEED) {
                walkFrameTimer = 0;
                currentWalkFrame = currentWalkFrame === 0 ? 1 : 0;
            }
        } else {
            currentWalkFrame = 0;
            walkFrameTimer = 0;
        }

        if (player.isMoving) {
            const dx = player.targetX - player.x;
            const dy = player.targetY - player.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance > 0) {
                lastDirection = getDirection(dx, dy);
            }

            if (distance > player.speed) {
                player.x += (dx / distance) * player.speed;
                player.y += (dy / distance) * player.speed;
            } else {
                player.x = player.targetX;
                player.y = player.targetY;
                player.isMoving = false;
            }

            cameraX = player.x - canvasW / 2;
            cameraY = player.y - canvasH / 2;
        }
        
        // Atualizar coordenadas em tempo real
        if (player.isMoving) {
            atualizarCoordenadas();
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvasW, canvasH);

        if (images.background && images.background.complete) {
            const patternX = -(cameraX % images.background.width);
            const patternY = -(cameraY % images.background.height);
            for (let x = patternX - images.background.width; x < canvasW + images.background.width; x += images.background.width) {
                for (let y = patternY - images.background.height; y < canvasH + images.background.height; y += images.background.height) {
                    ctx.drawImage(images.background, x, y, images.background.width, images.background.height);
                }
            }
        }

        estruturas.forEach(estrutura => {
            if (estrutura.loaded) {
                const estruturaScreenX = estrutura.x - cameraX;
                const estruturaScreenY = estrutura.y - cameraY;
                
                let imagemParaUsar;
                switch(estrutura.tipo) {
                    case 'lideranca':
                        if (images.lideranca && images.lideranca.complete) imagemParaUsar = images.lideranca;
                        break;
case 'barraco_familiar':
    // Se for n√≠vel 2 ou superior e n√£o for a primeira estrutura (lideran√ßas)
    if (nivelCasaPersonagem >= 2 && estrutura.id >= 1 && estrutura.id <= 8) {
        // Cada fam√≠lia tem uma imagem diferente (id 1 = B2, etc.)
        const indiceFamilia = estrutura.id - 1; // id 1 = Fam√≠lia Silva (√≠ndice 0), etc.
        
        // Verificar se temos a imagem espec√≠fica carregada
        if (imagesVizinhos[indiceFamilia] && 
            imagesVizinhos[indiceFamilia].complete && 
            imagesVizinhos[indiceFamilia].naturalWidth > 0) {
            imagemParaUsar = imagesVizinhos[indiceFamilia];
        } else {
            // Fallback para a imagem padr√£o do n√≠vel atual
            if (nivelCasaPersonagem === 0) {
                // Tentar carregar imagem do n√≠vel 0
                const img = new Image();
                img.src = imagensVizinhosPorNivel[0][0];
                imagemParaUsar = img;
            } else if (nivelCasaPersonagem === 1) {
                // Tentar carregar imagem do n√≠vel 1
                const img = new Image();
                img.src = imagensVizinhosPorNivel[1][0];
                imagemParaUsar = img;
            } else {
                // Usar imagem padr√£o como √∫ltimo recurso
                if (images.barracoFamiliar && images.barracoFamiliar.complete) {
                    imagemParaUsar = images.barracoFamiliar;
                }
            }
        }
    } else {
        // N√≠veis 0 e 1, ou se n√£o for uma fam√≠lia (id inv√°lido)
        if (images.barracoFamiliar && images.barracoFamiliar.complete) {
            imagemParaUsar = images.barracoFamiliar;
        }
    }
    break;
                    case 'barraco_personagem':
                        if (images.barracoPersonagem && images.barracoPersonagem.complete) imagemParaUsar = images.barracoPersonagem;
                        break;
                    case 'acude':
                        if (images.acude && images.acude.complete) imagemParaUsar = images.acude;
                        break;
                }
                
                if (imagemParaUsar) {
                    ctx.drawImage(
                        imagemParaUsar, 
                        estruturaScreenX, 
                        estruturaScreenY,
                        estrutura.width, 
                        estrutura.height
                    );
                }
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.font = estrutura.tipo === 'acude' ? 'bold 14px Arial' : 'bold 12px Arial';
                ctx.textAlign = 'center';
                
                let texto;
                if (estrutura.tipo === 'acude') {
                    texto = 'A√ßude';
                } else if (estrutura.id === 9) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 1)';
                    ctx.font = 'bold 14px Arial';
                    texto = `Sua Casa Nv.${nivelCasaPersonagem}`;
                } else {
                    texto = `B${estrutura.id + 1}`;
                }
                
                ctx.fillText(
                    texto, 
                    estruturaScreenX + estrutura.width / 2, 
                    estruturaScreenY + estrutura.height - 10
                );
                
                if (estrutura.isHovered) {
                    ctx.strokeStyle = 'rgba(255, 255, 0, 0.6)';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(estruturaScreenX, estruturaScreenY, estrutura.width, estrutura.height);
                    
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.1)';
                    ctx.fillRect(estruturaScreenX, estruturaScreenY, estrutura.width, estrutura.height);
                }
            }
        });

        drawEmojis();

        const playerOnEstrutura = isPlayerOnEstrutura();
        
        if (!playerOnEstrutura) {
            drawPersonagem();
        } else {
            if (!player.isMoving) {
                drawPersonagem();
            }
        }

      // 3. APENAS a √ÅRVORE - fica SOBRE o personagem
    drawTreeOnly();

        // Atualizar coordenadas na tela
        atualizarCoordenadas();

        requestAnimationFrame(gameLoop);
    }

// Fun√ß√£o para for√ßar atualiza√ß√£o das imagens dos vizinhos
function forcarAtualizacaoVizinhos() {
    console.log(`Atualizando imagens dos vizinhos para n√≠vel: ${nivelCasaPersonagem}`);
    
    // Limpar array de imagens
    for (let i = 0; i < imagesVizinhos.length; i++) {
        imagesVizinhos[i] = null;
    }
    
    // Recarregar imagens
    carregarImagensVizinhos();
    
    // For√ßar redesenho
    requestAnimationFrame(gameLoop);
}


    function drawPersonagem() {
        let currentImage;
        let currentDims;
        
        // Determinar qual conjunto de imagens usar baseado no personagem atual
        let prefixo = '';
        if (personagemAtual === 'mae') {
            prefixo = 'mae_';
        } else if (personagemAtual === 'filho') {
            prefixo = 'filho_';
        }
        
        if (player.isMoving) {
            switch(lastDirection) {
                case 'left':
                    currentImage = currentWalkFrame === 0 ? images[`${prefixo}walkLeft1`] : images[`${prefixo}walkLeft2`];
                    currentDims = currentWalkFrame === 0 ? imageDimensions[`${prefixo}walkLeft1`] : imageDimensions[`${prefixo}walkLeft2`];
                    break;
                case 'right':
                    currentImage = currentWalkFrame === 0 ? images[`${prefixo}walkRight1`] : images[`${prefixo}walkRight2`];
                    currentDims = currentWalkFrame === 0 ? imageDimensions[`${prefixo}walkRight1`] : imageDimensions[`${prefixo}walkRight2`];
                    break;
                case 'up':
                    currentImage = currentWalkFrame === 0 ? images[`${prefixo}walkUp1`] : images[`${prefixo}walkUp2`];
                    currentDims = currentWalkFrame === 0 ? imageDimensions[`${prefixo}walkUp1`] : imageDimensions[`${prefixo}walkUp2`];
                    break;
                case 'down':
                default:
                    currentImage = currentWalkFrame === 0 ? images[`${prefixo}walkDown1`] : images[`${prefixo}walkDown2`];
                    currentDims = currentWalkFrame === 0 ? imageDimensions[`${prefixo}walkDown1`] : imageDimensions[`${prefixo}walkDown2`];
                    break;
            }
        } else {
            switch(lastDirection) {
                case 'left':
                    currentImage = images[`${prefixo}idleLeft`];
                    currentDims = imageDimensions[`${prefixo}idleLeft`];
                    break;
                case 'right':
                    currentImage = images[`${prefixo}idleRight`];
                    currentDims = imageDimensions[`${prefixo}idleRight`];
                    break;
                case 'up':
                    currentImage = images[`${prefixo}idleUp`];
                    currentDims = imageDimensions[`${prefixo}idleUp`];
                    break;
                case 'down':
                default:
                    currentImage = images[`${prefixo}idleDown`];
                    currentDims = imageDimensions[`${prefixo}idleDown`];
                    break;
            }
        }
        
        if (currentImage && currentImage.complete && currentDims && currentDims.loaded) {
            const drawWidth = currentDims.width;
            const drawHeight = currentDims.height;
            
            ctx.drawImage(
                currentImage, 
                player.x - cameraX - drawWidth / 2, 
                player.y - cameraY - drawHeight / 2,
                drawWidth, 
                drawHeight
            );
            
            player.width = drawWidth;
            player.height = drawHeight;
        }
    }

    function gameLoop(time) {
        update(time);
        draw();
    }

    function carregarImagens() {
        let imagensCarregadas = 0;
        const totalImagens = Object.keys(imageUrls).length;
        
        criarEstruturas();
        
        for (const key in imageUrls) {
            images[key].src = imageUrls[key];
            images[key].onload = function() {
                imagensCarregadas++;
                
                if (imageDimensions.hasOwnProperty(key)) {
                    const dims = calculateDimensions(
                        this.width, 
                        this.height, 
                        CHARACTER_SIZE.baseWidth, 
                        CHARACTER_SIZE.baseHeight
                    );
                    imageDimensions[key] = {
                        width: dims.width,
                        height: dims.height,
                        loaded: true
                    };
                    
                    if ((key === 'idleDown' || key === 'mae_idleDown' || key === 'filho_idleDown') && player.width === 0) {
                        player.width = dims.width;
                        player.height = dims.height;
                    }
                }
                
                if (key === 'lideranca') {
                    const larguraLideranca = 250;
                    const alturaLideranca = 250;
                    const dimsLideranca = calculateDimensions(
                        this.width, 
                        this.height, 
                        larguraLideranca,
                        alturaLideranca
                    );
                    
                    estruturas.forEach(estrutura => {
                        if (estrutura.tipo === 'lideranca') {
                            estrutura.width = dimsLideranca.width;
                            estrutura.height = dimsLideranca.height;
                            estrutura.loaded = true;
                        }
                    });
                } else if (key === 'barracoFamiliar') {
                    const dimsFamiliar = calculateDimensions(
                        this.width, 
                        this.height, 
                        barracaConfig.width,
                        barracaConfig.height
                    );
                    
                    estruturas.forEach(estrutura => {
                        if (estrutura.tipo === 'barraco_familiar') {
                            estrutura.width = dimsFamiliar.width;
                            estrutura.height = dimsFamiliar.height;
                            estrutura.loaded = true;
                        }
                    });
                } else if (key === 'barracoPersonagem') {
                    const dimsPersonagem = calculateDimensions(
                        this.width, 
                        this.height, 
                        barracaConfig.width,
                        barracaConfig.height
                    );
                    
                    estruturas.forEach(estrutura => {
                        if (estrutura.tipo === 'barraco_personagem') {
                            estrutura.width = dimsPersonagem.width;
                            estrutura.height = dimsPersonagem.height;
                            estrutura.loaded = true;
                        }
                    });
                } else if (key === 'acude') {
                    const larguraAcude = 350;
                    const alturaAcude = 300;
                    const dimsAcude = calculateDimensions(
                        this.width, 
                        this.height, 
                        larguraAcude,
                        alturaAcude
                    );
                    
                    estruturas.forEach(estrutura => {
                        if (estrutura.tipo === 'acude') {
                            estrutura.width = dimsAcude.width;
                            estrutura.height = dimsAcude.height;
                            estrutura.loaded = true;
                        }
                    });
                }
                
                if (imagensCarregadas === totalImagens) {
                    iniciarJogo();
                }
            };
            
            images[key].onerror = function() {
                console.error(`Erro ao carregar imagem: ${key}`);
                imagensCarregadas++;
                
                if (imagensCarregadas === totalImagens) {
                    iniciarJogo();
                }
            };
        }
    }

    function iniciarJogo() {
        // Carregar o jogo salvo
        const carregou = carregarJogo();
        
        // Inicializar invent√°rio se n√£o carregado
        if (!carregou) {
            atualizarInventario();
            inicializarCarrosselCredito();
            iniciarDegradacaoPlantas();
            iniciarMovimentoAnimais();
        }
        
        atualizarIndicadores();
        SistemaIndicadores.init();
        requestAnimationFrame(gameLoop);
        
        // Mostrar mensagem de boas-vindas
        setTimeout(() => {
            if (!carregou) {
                mostrarAlerta('üå±', 'BOAS-VINDAS!!', 'Voc√™ agora faz parte de um Assentamento do INCRA! Cultive plantas, crie animais e fortale√ßa sua comunidade!');
            } else {
                mostrarAlertaSucesso('Progresso carregado com sucesso! Continue sua jornada no assentamento.');
            }
        }, 1000);
    }

    // --- EVENT LISTENERS ---
    canvas.addEventListener('pointerdown', (e) => {
    if (gameOver) return;
    
    const x = e.clientX;
    const y = e.clientY;
    
    const emojiIndex = getEmojiClicado(x, y);
    if (emojiIndex !== -1) {
        e.preventDefault();
        e.stopPropagation();
        
        // ‚≠ê BLOQUEAR MOVIMENTO DO PERSONAGEM
        player.isMoving = false;
        player.targetX = player.x;
        player.targetY = player.y;
        
        // ‚≠ê AGUARDAR 50ms ANTES DE ABRIR MENU
        setTimeout(() => {
            const planta = emojisFixos[emojiIndex];
            const configurado = configurarMenuPlanta(planta);
            if (configurado) {
                abrirMenuPlanta(x, y);
                SistemaIndicadores.registrarClique();
                tocarSom('somClique');
            }
        }, 50);  // Delay de 50 milissegundos
        
        return;
    }
        
        const estruturaIndex = getEstruturaClicada(x, y);
        if (estruturaIndex !== -1) {
            e.preventDefault();
            e.stopPropagation();
            estruturaAtualSelecionada = estruturaIndex;
            const estrutura = estruturas[estruturaIndex];
            configurarMenu(estrutura);
            abrirMenuBarraca(x, y);
            SistemaIndicadores.registrarClique();
            tocarSom('somClique');
            return;
        }
        
        player.targetX = x + cameraX;
        player.targetY = y + cameraY;
        player.isMoving = true;
        
        SistemaIndicadores.registrarClique();
        SistemaIndicadores.registrarMovimento();
        tocarSom('somClique');
    });

    canvas.addEventListener('pointermove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        
        updateHoverEstruturas(mouseX, mouseY);
    });

    fecharMenu.addEventListener('click', () => {
        menuBarraca.style.display = 'none';
        estruturaAtualSelecionada = -1;
        tocarSom('somClique');
    });

    fecharMenuPlanta.addEventListener('click', () => {
        menuPlanta.style.display = 'none';
        plantaSelecionada = -1;
        tocarSom('somClique');
    });

    // Logo do Jogo - Adicionar evento de clique
    document.getElementById('logoJogo').addEventListener('click', function() {
        mostrarAlerta('üö©', 'CRIADO POR:', 'Raphael Coutinho Santos - Analista Administrativo // INCRA ES - Matr√≠cula: 3490061');
    });

    // Configurar clique no slot externo
    itemEmUso.onclick = function() {
        if (!gameOver) {
            abrirInventario();
            tocarSom('somClique');
        }
    };

    // Configurar seletores de personagem
    document.querySelectorAll('.emoji-personagem').forEach(sel => {
        sel.addEventListener('click', function() {
            const personagem = this.dataset.personagem;
            trocarPersonagem(personagem);
        });
    });

    document.addEventListener('click', (e) => {
        if (menuBarraca.style.display === 'block' && 
            !menuBarraca.contains(e.target) && 
            e.target !== canvas) {
            menuBarraca.style.display = 'none';
            estruturaAtualSelecionada = -1;
        }
        
        if (menuPlanta.style.display === 'block' && 
            !menuPlanta.contains(e.target) && 
            e.target !== canvas) {
            menuPlanta.style.display = 'none';
            plantaSelecionada = -1;
        }
        
        // Fechar modais quando clicar fora
        if (modalConversa.style.display === 'block' && 
            !modalConversa.contains(e.target)) {
            // N√£o fecha automaticamente - o jogador deve usar o bot√£o X
        }
    });

    window.addEventListener('resize', () => {
        canvasW = window.innerWidth;
        canvasH = window.innerHeight;
        canvas.width = canvasW;
        canvas.height = canvasH;
    });

    // Event Listeners de navega√ß√£o
    miniMapaBtn.addEventListener('click', () => {
        if (isLoading) return;
        ultimaAtividade = Date.now();
        mostrarCoordenadas();
    });

    // Registrar atividade do mouse para resetar timer
    canvas.addEventListener('pointerdown', (e) => {
        if (isLoading) return;
        
        ultimaAtividade = Date.now();
        if (coordenadasVisiveis) {
            resetInactivityTimer();
        }
    });

    canvas.addEventListener('pointermove', (e) => {
        if (isLoading) return;
        
        ultimaAtividade = Date.now();
        if (coordenadasVisiveis) {
            resetInactivityTimer();
        }
    });

    // Iniciar o jogo
    carregarImagens();
</script>
<!-- Player de M√∫sica Elfsight -->
<script src="https://elfsightcdn.com/platform.js" async></script>
<div class="elfsight-app-2df338e0-2ba9-46a0-9b91-051e4d719f9e" data-elfsight-app-lazy></div>
</body>
</html>
